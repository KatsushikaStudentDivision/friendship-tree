<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>友情の木 - 管理画面</title>
  <style>
    /* お好みのスタイル */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; background-color: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
    h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eaeaea; padding-bottom: 15px; }
    .form-section { margin-bottom: 30px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50; }
    h2 { margin-bottom: 15px; color: #2c3e50; font-size: 1.4em; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="url"], input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
    input[type="file"] { display: block; margin-top: 5px; }
    button { padding: 12px 20px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
    button:hover { background-color: #388e3c; }
    .buttons { display: flex; justify-content: space-between; margin-top: 20px; }
    .preview-btn { background-color: #2196f3; }
    .preview-btn:hover { background-color: #1976d2; }
    .home-btn { background-color: #9e9e9e; }
    .home-btn:hover { background-color: #757575; }
    .image-manager { margin-top: 20px; }
    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .image-item { border: 1px solid #ddd; border-radius: 4px; padding: 10px; text-align: center; position: relative; }
    .image-item img { max-width: 100%; height: auto; display: block; margin-bottom: 5px; }
    .image-item .stage-number { font-weight: bold; }
    .image-upload { margin-bottom: 10px; padding: 10px; background-color: #e8f5e9; border-radius: 4px; }
    .success-message { background-color: #e8f5e9; color: #388e3c; padding: 15px; margin-top: 20px; border-radius: 4px; text-align: center; display: none; }
    .error-message { background-color: #ffebee; color: #d32f2f; padding: 15px; margin-top: 20px; border-radius: 4px; text-align: center; display: none; }
    footer { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 0.9rem; }
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4caf50; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .stage-settings { margin-top: 20px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
    .stage-settings-header { display: grid; grid-template-columns: 100px 1fr; background-color: #f1f8e9; padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; }
    .stage-row { display: grid; grid-template-columns: 100px 1fr; padding: 8px 10px; border-bottom: 1px solid #eee; }
    .stage-row:nth-child(even) { background-color: #f9f9f9; }
    .stage-row:last-child { border-bottom: none; }
    .stage-input { width: 100%; max-width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
    .btn-small { padding: 5px 10px; font-size: 14px; margin-left: 10px; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 4px 4px 0 0; margin-right: 5px; }
    .tab.active { background-color: #fff; border-color: #ddd; border-bottom-color: #fff; margin-bottom: -1px; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>友情の木 - 管理画面</h1>
    
    <div class="tabs">
      <div class="tab active" data-tab="basic-settings">基本設定</div>
      <div class="tab" data-tab="stage-settings">成長段階設定</div>
      <div class="tab" data-tab="image-settings">画像設定</div>
    </div>
    
    <div id="basic-settings" class="tab-content active">
      <div class="form-section">
        <h2>基本設定</h2>
        <div class="form-group">
          <label for="api-url">Google Apps Script API URL:</label>
          <input type="url" id="api-url" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec" value="https://script.google.com/macros/s/AKfycbzWXiOs5_yCmsdd9jpcCgpqlI1tlmpqzt2-I0CQBN6qtdOX_V-_91MM7UtRmo_Z51z00Q/exec">
          <small>※ GASをWebアプリとしてデプロイしたURLを入力してください</small>
        </div>
      </div>
    </div>
    
    <div id="stage-settings" class="tab-content">
      <div class="form-section">
        <h2>成長段階の設定</h2>
        <p>各成長段階に必要な交流回数を設定します。例：段階3は交流回数15回以上で表示</p>
        
        <div class="stage-settings">
          <div class="stage-settings-header">
            <div>成長段階</div>
            <div>必要な交流回数</div>
          </div>
          <div id="stage-rows-container">
            <!-- JavaScriptで行を追加 -->
          </div>
        </div>
        
        <div style="margin-top: 15px; display: flex; justify-content: space-between;">
          <button id="reset-stages-btn" class="btn-small" style="background-color: #ff9800;">初期値にリセット</button>
          <button id="auto-distribute-btn" class="btn-small" style="background-color: #2196f3;">均等に自動設定</button>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label for="max-meetings">最大交流回数:</label>
          <input type="number" id="max-meetings" placeholder="例: 150" min="30" value="150">
          <small>※ 自動設定時に使用する最大交流回数</small>
        </div>
      </div>
    </div>
    
    <div id="image-settings" class="tab-content">
      <div class="form-section">
        <h2>成長段階の画像設定</h2>
        <p>30段階の成長をスライドショーで表示するための画像を設定します。各段階ごとに画像をアップロードまたはURL指定してください。</p>
        
        <div class="image-upload">
          <label for="stage-selector">設定する成長段階:</label>
          <select id="stage-selector">
            <!-- JavaScriptでオプションを追加 -->
          </select>
          
          <div class="form-group">
            <label for="image-url">画像URL:</label>
            <input type="url" id="image-url" placeholder="https://example.com/tree-image.jpg">
          </div>
          
          <p>または</p>
          
          <div class="form-group">
            <label for="image-upload">画像をアップロード:</label>
            <input type="file" id="image-upload" accept="image/*">
          </div>
          
          <button id="save-image-btn">この段階の画像を保存</button>
        </div>
        
        <div class="image-manager">
          <h3>登録済みの画像</h3>
          <div class="image-grid" id="image-grid">
            <!-- JavaScriptで画像を追加 -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="loader" id="loader"></div>
    <div class="success-message" id="success-message">設定が保存されました！</div>
    <div class="error-message" id="error-message"></div>
    
    <div class="buttons">
      <button id="save-settings-btn">すべての設定を保存</button>
      <button id="preview-btn" class="preview-btn">メイン画面をプレビュー</button>
      <button id="home-btn" class="home-btn">メイン画面に戻る</button>
    </div>
  </div>
  
  <footer>
    友情の木 管理ツール - 設定変更はこの画面から行ってください
  </footer>
  
  <script>
    const adminApp = {
      config: {
        apiUrl: 'https://script.google.com/macros/s/AKfycbzWXiOs5_yCmsdd9jpcCgpqlI1tlmpqzt2-I0CQBN6qtdOX_V-_91MM7UtRmo_Z51z00Q/exec',
        stages: [],
        images: []
      },
      elements: {
        apiUrlInput: document.getElementById('api-url'),
        stageSelector: document.getElementById('stage-selector'),
        imageUrlInput: document.getElementById('image-url'),
        imageUploadInput: document.getElementById('image-upload'),
        saveImageBtn: document.getElementById('save-image-btn'),
        imageGrid: document.getElementById('image-grid'),
        saveSettingsBtn: document.getElementById('save-settings-btn'),
        previewBtn: document.getElementById('preview-btn'),
        homeBtn: document.getElementById('home-btn'),
        loader: document.getElementById('loader'),
        successMessage: document.getElementById('success-message'),
        errorMessage: document.getElementById('error-message'),
        stageRowsContainer: document.getElementById('stage-rows-container'),
        resetStagesBtn: document.getElementById('reset-stages-btn'),
        autoDistributeBtn: document.getElementById('auto-distribute-btn'),
        maxMeetingsInput: document.getElementById('max-meetings'),
        tabs: document.querySelectorAll('.tab'),
        tabContents: document.querySelectorAll('.tab-content')
      },
      
      init: function() {
        this.loadConfig(); // GASから設定を取得（GET with ?action=getConfig）
        this.updateUI();
        this.setupEventListeners();
      },
      
      // GASから設定取得
      loadConfig: function() {
        if (this.config.apiUrl) {
          fetch(this.config.apiUrl + '?action=getConfig')
            .then(response => response.json())
            .then(data => {
              this.config = { ...this.config, ...data };
              console.log('サーバーから設定を読み込みました:', this.config);
              this.updateUI();
            })
            .catch(error => {
              console.error('設定取得に失敗:', error);
              this.showErrorMessage('サーバーからの設定取得に失敗しました。');
            });
        } else {
          console.log('API URL未設定のため、ローカルのデフォルト値使用');
          if (!this.config.stages || !Array.isArray(this.config.stages) || this.config.stages.length === 0) {
            this.setupDefaultStages();
          }
          if (!this.config.images || !Array.isArray(this.config.images)) {
            this.config.images = Array(31).fill('');
          }
        }
      },
      
      setupDefaultStages: function() {
        this.config.stages = [];
        const maxMeetings = 150;
        const totalStages = 30;
        for (let i = 0; i <= totalStages; i++) {
          const meetingsRequired = Math.floor((i / totalStages) * maxMeetings);
          this.config.stages.push(meetingsRequired);
        }
      },
      
      autoDistributeStages: function() {
        const maxMeetings = parseInt(this.elements.maxMeetingsInput.value) || 150;
        const totalStages = 30;
        this.config.stages = [];
        for (let i = 0; i <= totalStages; i++) {
          const meetingsRequired = Math.floor((i / totalStages) * maxMeetings);
          this.config.stages.push(meetingsRequired);
        }
        this.updateStageSettings();
      },
      
      updateUI: function() {
        this.elements.apiUrlInput.value = this.config.apiUrl || '';
        this.elements.maxMeetingsInput.value = Math.max(...this.config.stages) || 150;
        this.updateStageSelector();
        this.updateStageSettings();
        this.updateImageGrid();
      },
      
      updateStageSelector: function() {
        this.elements.stageSelector.innerHTML = '';
        for (let i = 0; i <= 30; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `段階 ${i}`;
          this.elements.stageSelector.appendChild(option);
        }
      },
      
      updateStageSettings: function() {
        this.elements.stageRowsContainer.innerHTML = '';
        for (let i = 0; i <= 30; i++) {
          const row = document.createElement('div');
          row.className = 'stage-row';
          const stageLabel = document.createElement('div');
          stageLabel.textContent = `段階 ${i}`;
          const inputContainer = document.createElement('div');
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.className = 'stage-input';
          input.value = this.config.stages[i] || 0;
          input.dataset.stage = i;
          input.addEventListener('change', (e) => {
            const stage = parseInt(e.target.dataset.stage);
            const value = parseInt(e.target.value) || 0;
            this.config.stages[stage] = value;
          });
          inputContainer.appendChild(input);
          row.appendChild(stageLabel);
          row.appendChild(inputContainer);
          this.elements.stageRowsContainer.appendChild(row);
        }
      },
      
      updateImageGrid: function() {
        this.elements.imageGrid.innerHTML = '';
        this.config.images.forEach((imageUrl, index) => {
          if (index > 30) return;
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          const stageNumber = document.createElement('div');
          stageNumber.className = 'stage-number';
          stageNumber.textContent = `段階 ${index}`;
          const img = document.createElement('img');
          img.src = imageUrl ? imageUrl : `https://via.placeholder.com/150x150.png?text=Stage+${index}`;
          img.alt = `成長段階 ${index}`;
          const editBtn = document.createElement('button');
          editBtn.textContent = '編集';
          editBtn.className = 'btn-small';
          editBtn.addEventListener('click', () => {
            this.elements.stageSelector.value = index;
            this.elements.imageUrlInput.value = imageUrl || '';
            this.elements.imageUrlInput.focus();
            this.activateTab('image-settings');
          });
          imageItem.appendChild(stageNumber);
          imageItem.appendChild(img);
          imageItem.appendChild(editBtn);
          this.elements.imageGrid.appendChild(imageItem);
        });
      },
      
      activateTab: function(tabId) {
        this.elements.tabs.forEach(tab => tab.classList.remove('active'));
        this.elements.tabContents.forEach(content => content.classList.remove('active'));
        const targetTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        const targetContent = document.getElementById(tabId);
        if (targetTab && targetContent) {
          targetTab.classList.add('active');
          targetContent.classList.add('active');
        }
      },
      
      setupEventListeners: function() {
        this.elements.tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            this.activateTab(tabId);
          });
        });
        this.elements.saveImageBtn.addEventListener('click', () => {
          this.saveStageImage();
        });
        this.elements.saveSettingsBtn.addEventListener('click', () => {
          this.saveSettings();
        });
        this.elements.previewBtn.addEventListener('click', () => {
          window.open('index.html', '_blank');
        });
        this.elements.homeBtn.addEventListener('click', () => {
          window.location.href = 'index.html';
        });
        this.elements.imageUploadInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file) {
            this.handleImageUpload(file);
          }
        });
        this.elements.resetStagesBtn.addEventListener('click', () => {
          if (confirm('段階設定を初期値に戻しますか？')) {
            this.setupDefaultStages();
            this.updateStageSettings();
            this.showSuccessMessage('段階設定を初期値にリセットしました');
          }
        });
        this.elements.autoDistributeBtn.addEventListener('click', () => {
          this.autoDistributeStages();
          this.showSuccessMessage('段階設定を均等に自動設定しました');
        });
      },
      
      handleImageUpload: function(file) {
        if (!file) return;
        if (!file.type.startsWith('image/')) {
          this.showErrorMessage('画像ファイルを選択してください');
          return;
        }
        if (file.size > 5 * 1024 * 1024) {
          this.showErrorMessage('ファイルサイズが大きすぎます（最大5MB）');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          const imageData = e.target.result;
          this.elements.imageUrlInput.value = imageData;
        };
        reader.onerror = (error) => {
          console.error('画像読み込み失敗:', error);
          this.showErrorMessage('画像の読み込みに失敗しました。');
        };
        reader.readAsDataURL(file);
      },
      
      saveStageImage: function() {
        const stageIndex = parseInt(this.elements.stageSelector.value);
        const imageUrl = this.elements.imageUrlInput.value.trim();
        // チェック：Flickr のページ URL が入力されている場合はエラー表示
        if (imageUrl.indexOf('flickr.com') !== -1 && !/\.(jpg|jpeg|png|gif)(\?.*)?$/i.test(imageUrl)) {
          this.showErrorMessage("Flickr のページURLが入力されています。直接画像ファイル（例：.jpg, .png）の URL を入力してください。");
          return;
        }
        while (this.config.images.length <= stageIndex) {
          this.config.images.push('');
        }
        this.config.images[stageIndex] = imageUrl;
        // 保存は saveSettings() で GAS に POST リクエスト
        this.saveSettings();
        this.updateImageGrid();
        this.showSuccessMessage('段階 ' + stageIndex + ' の画像が保存されました！');
        this.elements.imageUrlInput.value = '';
        this.elements.imageUploadInput.value = '';
      },
      
      saveSettings: function() {
        this.config.apiUrl = this.elements.apiUrlInput.value.trim();
        const stageInputs = document.querySelectorAll('.stage-input');
        stageInputs.forEach(input => {
          const stage = parseInt(input.dataset.stage);
          const value = parseInt(input.value) || 0;
          this.config.stages[stage] = value;
        });
        this.elements.loader.style.display = 'block';
        fetch(this.config.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveConfig',
            config: this.config
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            this.showSuccessMessage('すべての設定が保存されました！メイン画面に反映されます。');
          } else {
            this.showErrorMessage('保存エラー: ' + data.message);
          }
        })
        .catch(error => {
          console.error('保存エラー:', error);
          this.showErrorMessage('設定の保存に失敗しました。');
        })
        .finally(() => {
          this.elements.loader.style.display = 'none';
        });
      },
      
      showSuccessMessage: function(message) {
        this.elements.successMessage.textContent = message;
        this.elements.successMessage.style.display = 'block';
        this.elements.errorMessage.style.display = 'none';
        setTimeout(() => {
          this.elements.successMessage.style.display = 'none';
        }, 3000);
      },
      
      showErrorMessage: function(message) {
        this.elements.errorMessage.textContent = message;
        this.elements.errorMessage.style.display = 'block';
        this.elements.successMessage.style.display = 'none';
        setTimeout(() => {
          this.elements.errorMessage.style.display = 'none';
        }, 5000);
      }
    };
    
    document.addEventListener('DOMContentLoaded', function() {
      adminApp.init();
    });
  </script>
</body>
</html>
