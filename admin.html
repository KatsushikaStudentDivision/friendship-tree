<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>友情の木 - 管理画面</title>
  <style>
    /* スタイルは変更なし */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; background-color: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
    h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eaeaea; padding-bottom: 15px; }
    .form-section { margin-bottom: 30px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50; }
    h2 { margin-bottom: 15px; color: #2c3e50; font-size: 1.4em; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="url"], input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
    input[type="file"] { display: block; margin-top: 5px; }
    button { padding: 12px 20px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
    button:hover { background-color: #388e3c; }
    button:disabled { background-color: #ccc; cursor: not-allowed; } /* disabledスタイル追加 */
    .buttons { display: flex; justify-content: space-between; margin-top: 20px; }
    .preview-btn { background-color: #2196f3; }
    .preview-btn:hover { background-color: #1976d2; }
    .home-btn { background-color: #9e9e9e; }
    .home-btn:hover { background-color: #757575; }
    .image-manager { margin-top: 20px; }
    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .image-item { border: 1px solid #ddd; border-radius: 4px; padding: 10px; text-align: center; position: relative; }
    .image-item img { max-width: 100%; height: auto; display: block; margin-bottom: 5px; min-height: 100px; background-color:#eee; } /* min-height追加 */
    .image-item .stage-number { font-weight: bold; }
    .image-upload { margin-bottom: 10px; padding: 10px; background-color: #e8f5e9; border-radius: 4px; }
    .success-message { background-color: #e8f5e9; color: #388e3c; padding: 15px; margin-top: 20px; border-radius: 4px; text-align: center; display: none; }
    .error-message { background-color: #ffebee; color: #d32f2f; padding: 15px; margin-top: 20px; border-radius: 4px; text-align: center; display: none; }
    footer { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 0.9rem; }
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4caf50; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .stage-settings { margin-top: 20px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
    .stage-settings-header { display: grid; grid-template-columns: 100px 1fr; background-color: #f1f8e9; padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; }
    .stage-row { display: grid; grid-template-columns: 100px 1fr; padding: 8px 10px; border-bottom: 1px solid #eee; }
    .stage-row:nth-child(even) { background-color: #f9f9f9; }
    .stage-row:last-child { border-bottom: none; }
    .stage-input { width: 100%; max-width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
    .btn-small { padding: 5px 10px; font-size: 14px; margin-left: 10px; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 4px 4px 0 0; margin-right: 5px; }
    .tab.active { background-color: #fff; border-color: #ddd; border-bottom-color: #fff; margin-bottom: -1px; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .file-info { font-size: 0.9em; color: #555; margin-top: 5px;} /* ファイル情報表示用 */
    .upload-progress { margin-top: 10px; } /* アップロード進捗表示用 */
  </style>
</head>
<body>
  <div class="container">
    <h1>友情の木 - 管理画面</h1>

    <div class="tabs">
      <div class="tab active" data-tab="basic-settings">基本設定</div>
      <div class="tab" data-tab="stage-settings">成長段階設定</div>
      <div class="tab" data-tab="image-settings">画像設定</div>
    </div>

    <div id="basic-settings" class="tab-content active">
      <div class="form-section">
        <h2>基本設定</h2>
        <div class="form-group">
          <label for="api-url">Google Apps Script API URL:</label>
          <input type="url" id="api-url" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec" value="https://script.google.com/macros/s/AKfycbymFEfHHxILiMex51XBRWszk69AYM0scaTXv3CmcLeWXsj7g-Ol4Nem0otDUBQ8dNy55w/exec">
          <small>※ GASをWebアプリとしてデプロイしたURLを入力してください</small>
        </div>
      </div>
    </div>

    <div id="stage-settings" class="tab-content">
      <div class="form-section">
        <h2>成長段階の設定</h2>
        <p>各成長段階に必要な交流回数を設定します。例：段階3は交流回数15回以上で表示</p>

        <div class="stage-settings">
          <div class="stage-settings-header">
            <div>成長段階</div>
            <div>必要な交流回数</div>
          </div>
          <div id="stage-rows-container">
            </div>
        </div>

        <div style="margin-top: 15px; display: flex; justify-content: space-between;">
          <button id="reset-stages-btn" class="btn-small" style="background-color: #ff9800;">初期値にリセット</button>
          <button id="auto-distribute-btn" class="btn-small" style="background-color: #2196f3;">均等に自動設定</button>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label for="max-meetings">最大交流回数:</label>
          <input type="number" id="max-meetings" placeholder="例: 150" min="30" value="150">
          <small>※ 自動設定時に使用する最大交流回数</small>
        </div>
      </div>
    </div>

    <div id="image-settings" class="tab-content">
      <div class="form-section">
        <h2>成長段階の画像設定</h2>
        <p>30段階の成長をスライドショーで表示するための画像を設定します。各段階ごとに画像をアップロードしてください（推奨）。URL指定も可能ですが、Google Driveへのアップロードが推奨されます。</p>

        <div class="image-upload">
          <label for="stage-selector">設定する成長段階:</label>
          <select id="stage-selector">
            </select>

          <div class="form-group">
             <label for="image-upload">画像をアップロード (推奨):</label>
             <input type="file" id="image-upload-input" accept="image/png, image/jpeg, image/gif">
             <div id="file-info" class="file-info"></div>
             <small>※ 推奨: PNG, JPG, GIF形式。ファイルサイズが大きい場合、アップロードに時間がかかることがあります。</small>
          </div>

          <p>または (非推奨: Driveアップロードを利用してください)</p>

          <div class="form-group">
            <label for="image-id-url">画像URL または Google Drive ファイルID:</label>
            <input type="text" id="image-id-url-input" placeholder="https://.../image.jpg または DriveのファイルID">
          </div>

          <button id="upload-image-btn" disabled>画像をアップロードして設定</button>
          <button id="set-id-url-btn">URL/IDを設定</button>
          <div id="upload-progress" class="upload-progress"></div>

        </div>

        <div class="image-manager">
          <h3>登録済みの画像</h3>
          <div class="image-grid" id="image-grid">
            </div>
        </div>
      </div>
    </div>

    <div class="loader" id="loader"></div>
    <div class="success-message" id="success-message"></div>
    <div class="error-message" id="error-message"></div>

    <div class="buttons">
      <button id="save-settings-btn">すべての設定を保存</button>
      <button id="preview-btn" class="preview-btn">メイン画面をプレビュー</button>
      <button id="home-btn" class="home-btn">メイン画面に戻る</button>
    </div>
  </div>

  <footer>
    友情の木 管理ツール - 設定変更はこの画面から行ってください
  </footer>

  <script>
    const adminApp = {
      config: {
        apiUrl: 'https://script.google.com/macros/s/AKfycbzWXiOs5_yCmsdd9jpcCgpqlI1tlmpqzt2-I0CQBN6qtdOX_V-_91MM7UtRmo_Z51z00Q/exec', // 初期値
        stages: [],
        images: [] // ここには Drive File ID または 画像URL が入る
      },
      elements: {
        apiUrlInput: document.getElementById('api-url'),
        stageSelector: document.getElementById('stage-selector'),
        imageUploadInput: document.getElementById('image-upload-input'), // ID変更
        fileInfo: document.getElementById('file-info'),
        uploadImageBtn: document.getElementById('upload-image-btn'), // ID変更
        imageIdUrlInput: document.getElementById('image-id-url-input'), // ID変更
        setIdUrlBtn: document.getElementById('set-id-url-btn'), // 新設
        uploadProgress: document.getElementById('upload-progress'),
        imageGrid: document.getElementById('image-grid'),
        saveSettingsBtn: document.getElementById('save-settings-btn'),
        previewBtn: document.getElementById('preview-btn'),
        homeBtn: document.getElementById('home-btn'),
        loader: document.getElementById('loader'),
        successMessage: document.getElementById('success-message'),
        errorMessage: document.getElementById('error-message'),
        stageRowsContainer: document.getElementById('stage-rows-container'),
        resetStagesBtn: document.getElementById('reset-stages-btn'),
        autoDistributeBtn: document.getElementById('auto-distribute-btn'),
        maxMeetingsInput: document.getElementById('max-meetings'),
        tabs: document.querySelectorAll('.tab'),
        tabContents: document.querySelectorAll('.tab-content')
      },
      selectedFile: null, // アップロード用に選択されたファイルを保持

      init: function() {
        // API URLをローカルストレージから読み込むか、デフォルト値を使用
        const savedApiUrl = localStorage.getItem('treeAppApiUrl');
        if (savedApiUrl) {
            this.config.apiUrl = savedApiUrl;
        }
        this.elements.apiUrlInput.value = this.config.apiUrl; // inputにも反映

        this.loadConfig(); // GASから設定を取得
        this.setupEventListeners();
        // 初期状態で画像設定タブのUIを更新しておく
        this.updateStageSelector();
      },

      // GASから設定取得 (変更なし)
      loadConfig: function() {
        if (this.config.apiUrl) {
          this.showLoader();
          fetch(this.config.apiUrl + '?action=getConfig')
            .then(response => response.json())
            .then(data => {
              // 保存されているAPI URLも更新する
              if (data.apiUrl && data.apiUrl !== this.config.apiUrl) {
                  this.config.apiUrl = data.apiUrl;
                  this.elements.apiUrlInput.value = this.config.apiUrl;
                  localStorage.setItem('treeAppApiUrl', this.config.apiUrl); // ローカルストレージにも保存
              }
              // stagesとimagesを読み込む（存在しない場合はデフォルトを設定）
              this.config.stages = (data.stages && Array.isArray(data.stages)) ? data.stages : [];
              this.config.images = (data.images && Array.isArray(data.images)) ? data.images : [];

              // stagesやimagesの長さが足りない場合に備える
              while (this.config.stages.length <= 30) this.config.stages.push(0);
              while (this.config.images.length <= 30) this.config.images.push('');

              if (this.config.stages.length === 1 && this.config.stages[0] === 0) { // 初期状態に近い場合
                  this.setupDefaultStages();
              }

              console.log('サーバーから設定を読み込みました:', this.config);
              this.updateUI(); // UI全体を更新
            })
            .catch(error => {
              console.error('設定取得に失敗:', error);
              this.showErrorMessage('サーバーからの設定取得に失敗しました。API URLを確認してください。');
              // エラー時もデフォルト設定でUIを表示試みる
              if (!this.config.stages || this.config.stages.length === 0) this.setupDefaultStages();
              if (!this.config.images) this.config.images = Array(31).fill('');
              this.updateUI();
            })
            .finally(() => {
              this.hideLoader();
            });
        } else {
          console.log('API URL未設定のため、ローカルのデフォルト値使用');
          this.setupDefaultStages();
          this.config.images = Array(31).fill('');
          this.updateUI();
        }
      },

      setupDefaultStages: function() {
        this.config.stages = [];
        const maxMeetings = parseInt(this.elements.maxMeetingsInput.value) || 150;
        const totalStages = 30;
        for (let i = 0; i <= totalStages; i++) {
          const meetingsRequired = Math.floor((i / totalStages) * maxMeetings);
          this.config.stages.push(meetingsRequired);
        }
        console.log('デフォルトの段階設定を作成');
        // 必要であればUIも更新
        if (document.getElementById('stage-settings').classList.contains('active')) {
            this.updateStageSettings();
        }
      },

      autoDistributeStages: function() {
        const maxMeetings = parseInt(this.elements.maxMeetingsInput.value) || 150;
        const totalStages = 30;
        this.config.stages = [];
        for (let i = 0; i <= totalStages; i++) {
          const meetingsRequired = Math.floor((i / totalStages) * maxMeetings);
          this.config.stages.push(meetingsRequired);
        }
        this.updateStageSettings(); // UI更新
      },

      updateUI: function() {
        this.elements.apiUrlInput.value = this.config.apiUrl || '';
        this.elements.maxMeetingsInput.value = Math.max(0, ...this.config.stages.slice(1)) || 150; // stage 0 は除く
        this.updateStageSelector(); // 常に呼ぶ
        // 現在アクティブなタブの内容を更新
        const activeTabId = document.querySelector('.tab.active')?.dataset.tab;
        if (activeTabId === 'stage-settings') {
            this.updateStageSettings();
        } else if (activeTabId === 'image-settings') {
            this.updateImageGrid(); // 画像グリッドも更新
        }
      },

      updateStageSelector: function() {
        const selectedValue = this.elements.stageSelector.value; // 現在の選択値を保持
        this.elements.stageSelector.innerHTML = '';
        for (let i = 0; i <= 30; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `段階 ${i}`;
          this.elements.stageSelector.appendChild(option);
        }
        if (selectedValue) {
          this.elements.stageSelector.value = selectedValue; // 選択値を復元
        }
        // セレクタ変更時にファイル選択状態をリセット
        this.elements.stageSelector.dispatchEvent(new Event('change'));
      },

      updateStageSettings: function() {
        this.elements.stageRowsContainer.innerHTML = '';
         if (!this.config.stages || this.config.stages.length === 0) {
            this.setupDefaultStages(); // stagesがなければ初期化
        }
        for (let i = 0; i <= 30; i++) {
          const row = document.createElement('div');
          row.className = 'stage-row';
          const stageLabel = document.createElement('div');
          stageLabel.textContent = `段階 ${i}`;
          const inputContainer = document.createElement('div');
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.className = 'stage-input';
          // 存在しないindexへのアクセスを防ぐ
          input.value = (this.config.stages && i < this.config.stages.length) ? this.config.stages[i] : 0;
          input.dataset.stage = i;
          input.addEventListener('change', (e) => {
            const stage = parseInt(e.target.dataset.stage);
            let value = parseInt(e.target.value) || 0;
            if (value < 0) value = 0; // マイナス値防止
            // 配列の長さを確認して拡張
            while (this.config.stages.length <= stage) {
                this.config.stages.push(0);
            }
            this.config.stages[stage] = value;
            // Stage 0は常に0にする (任意)
            if (stage === 0) {
                this.config.stages[0] = 0;
                e.target.value = 0;
            }
          });
          inputContainer.appendChild(input);
          row.appendChild(stageLabel);
          row.appendChild(inputContainer);
          this.elements.stageRowsContainer.appendChild(row);
        }
      },

      // 画像グリッド更新 (Drive IDに対応)
      updateImageGrid: function() {
        this.elements.imageGrid.innerHTML = '';
        if (!this.config.images) this.config.images = Array(31).fill(''); // imagesがなければ初期化

        // images配列の長さが足りなければ拡張
        while (this.config.images.length <= 30) this.config.images.push('');

        this.config.images.forEach((imageIdentifier, index) => {
          if (index > 30) return; // 0から30まで

          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';

          const stageNumber = document.createElement('div');
          stageNumber.className = 'stage-number';
          stageNumber.textContent = `段階 ${index}`;

          const img = document.createElement('img');
          img.alt = `成長段階 ${index}`;
          img.onerror = () => { // 画像読み込み失敗時の処理
              img.src = `https://via.placeholder.com/150x150.png?text=Stage+${index}+Error`;
              img.title = `画像読込エラー: ${imageIdentifier}`;
          };

          if (imageIdentifier) {
            // Google Drive File ID かどうかを判定 (単純な文字列チェック、より厳密な判定も可能)
            if (imageIdentifier.length > 20 && !imageIdentifier.startsWith('http') && !imageIdentifier.startsWith('data:')) {
              // Drive File ID とみなす
              img.src = `https://drive.google.com/uc?export=view&id=${imageIdentifier}`;
              img.title = `Drive ID: ${imageIdentifier}`;
            } else {
              // URL または Data URL とみなす
              img.src = imageIdentifier;
              img.title = `URL: ${imageIdentifier.substring(0, 50)}...`;
            }
          } else {
            img.src = `https://via.placeholder.com/150x150.png?text=Stage+${index}+No+Image`;
            img.title = '画像未設定';
          }

          const editBtn = document.createElement('button');
          editBtn.textContent = '選択'; // ボタン名を変更
          editBtn.className = 'btn-small';
          editBtn.addEventListener('click', () => {
            this.elements.stageSelector.value = index;
             // セレクタ変更イベントを発火させて、入力欄をクリア
            this.elements.stageSelector.dispatchEvent(new Event('change'));
             // 編集対象のID/URLを入力欄に入れる
            this.elements.imageIdUrlInput.value = imageIdentifier || '';
            this.activateTab('image-settings'); // 画像設定タブを開く
            this.elements.imageIdUrlInput.focus();
          });

          imageItem.appendChild(stageNumber);
          imageItem.appendChild(img);
          imageItem.appendChild(editBtn);
          this.elements.imageGrid.appendChild(imageItem);
        });
      },

      activateTab: function(tabId) {
        this.elements.tabs.forEach(tab => tab.classList.remove('active'));
        this.elements.tabContents.forEach(content => content.classList.remove('active'));

        const targetTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        const targetContent = document.getElementById(tabId);

        if (targetTab && targetContent) {
          targetTab.classList.add('active');
          targetContent.classList.add('active');

          // タブ切り替え時に内容を更新
          if (tabId === 'stage-settings') {
            this.updateStageSettings();
          } else if (tabId === 'image-settings') {
            this.updateImageGrid(); // グリッドも更新
          }
        }
      },

      setupEventListeners: function() {
        // タブ切り替え
        this.elements.tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            this.activateTab(tabId);
          });
        });

        // API URL変更時にローカルストレージにも保存
        this.elements.apiUrlInput.addEventListener('change', () => {
            this.config.apiUrl = this.elements.apiUrlInput.value.trim();
            localStorage.setItem('treeAppApiUrl', this.config.apiUrl);
        });


        // 画像ファイル選択時の処理
        this.elements.imageUploadInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file) {
            // ファイル情報を表示
            this.elements.fileInfo.textContent = `選択中: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            this.selectedFile = file;
            this.elements.uploadImageBtn.disabled = false; // アップロードボタンを有効化
             // URL/ID入力欄はクリア
            this.elements.imageIdUrlInput.value = '';
          } else {
            this.resetFileInput();
          }
        });

        // 段階セレクタ変更時の処理
         this.elements.stageSelector.addEventListener('change', () => {
             this.resetFileInput(); // ファイル選択・入力欄をリセット
             // 選択中の段階の画像ID/URLを入力欄に表示（編集用）
             const stageIndex = parseInt(this.elements.stageSelector.value);
             this.elements.imageIdUrlInput.value = this.config.images[stageIndex] || '';
         });

        // 画像アップロードボタンのクリック処理
        this.elements.uploadImageBtn.addEventListener('click', () => {
          if (this.selectedFile) {
            const stageIndex = parseInt(this.elements.stageSelector.value);
            this.uploadAndSaveImage(this.selectedFile, stageIndex);
          } else {
            this.showErrorMessage('アップロードする画像ファイルを選択してください。');
          }
        });

        // URL/ID設定ボタンのクリック処理
        this.elements.setIdUrlBtn.addEventListener('click', () => {
            const stageIndex = parseInt(this.elements.stageSelector.value);
            const idOrUrl = this.elements.imageIdUrlInput.value.trim();

            if (!idOrUrl) {
                 if (confirm(`段階 ${stageIndex} の画像をクリアしますか？`)) {
                    this.setImageIdentifier(stageIndex, '');
                    this.showSuccessMessage(`段階 ${stageIndex} の画像をクリアしました。`);
                 }
                 return;
            }

            // 簡単なURL/ID形式チェック (任意)
             if (idOrUrl.includes(' ') || (idOrUrl.startsWith('http') && !idOrUrl.includes('.')) ) {
                if (!confirm("入力された値はURLまたはDrive IDとして正しくない可能性があります。続行しますか？\n(例: https://.../image.png または 1aBcD... )")) {
                    return;
                }
            }

            this.setImageIdentifier(stageIndex, idOrUrl);
            this.showSuccessMessage(`段階 ${stageIndex} にURL/IDを設定しました。(保存ボタンを押して確定)`);
        });

        // すべての設定を保存ボタン
        this.elements.saveSettingsBtn.addEventListener('click', () => {
          this.saveSettings();
        });

        // プレビューボタン
        this.elements.previewBtn.addEventListener('click', () => {
          window.open('index.html', '_blank');
        });

        // メイン画面へボタン
        this.elements.homeBtn.addEventListener('click', () => {
          window.location.href = 'index.html';
        });

        // 段階設定リセットボタン
        this.elements.resetStagesBtn.addEventListener('click', () => {
          if (confirm('段階設定を初期値に戻しますか？')) {
            this.setupDefaultStages(); // stages配列をリセット
            this.updateStageSettings(); // UIを更新
            this.showSuccessMessage('段階設定を初期値にリセットしました。(保存ボタンを押して確定)');
          }
        });

        // 段階設定自動配布ボタン
        this.elements.autoDistributeBtn.addEventListener('click', () => {
          this.autoDistributeStages();
          this.showSuccessMessage('段階設定を均等に自動設定しました。(保存ボタンを押して確定)');
        });
      },

      // ファイル入力関連のリセット
      resetFileInput: function() {
          this.elements.imageUploadInput.value = ''; // ファイル選択をクリア
          this.elements.fileInfo.textContent = '';
          this.selectedFile = null;
          this.elements.uploadImageBtn.disabled = true; // アップロードボタンを無効化
          this.elements.uploadProgress.textContent = ''; // 進捗表示もクリア
          // URL/ID入力欄はクリアしない（段階セレクタ変更時に対応）
      },

      // 画像をアップロードしてファイルIDを取得し、configに保存する
      uploadAndSaveImage: function(file, stageIndex) {
        this.showLoader('画像をアップロード中...');
        this.elements.uploadProgress.textContent = '読み込み中...';
        this.elements.uploadImageBtn.disabled = true; // 処理中は無効化

        const reader = new FileReader();
        reader.onload = (e) => {
          const base64Data = e.target.result;
          this.elements.uploadProgress.textContent = 'サーバーに送信中...';

          fetch(this.config.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'uploadImage',
              fileData: {
                base64: base64Data,
                type: file.type,
                name: file.name
              }
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success' && data.fileId) {
              this.setImageIdentifier(stageIndex, data.fileId); // configにファイルIDを保存
              this.showSuccessMessage(`段階 ${stageIndex} の画像をアップロードしました！ Drive File ID: ${data.fileId} (保存ボタンを押して確定)`);
              this.resetFileInput(); // 成功したらファイル選択をリセット
              this.elements.imageIdUrlInput.value = data.fileId; // 入力欄にもIDを表示
            } else {
              throw new Error(data.message || '画像アップロードに失敗しました。');
            }
          })
          .catch(error => {
            console.error('画像アップロードエラー:', error);
            this.showErrorMessage(`画像アップロード失敗: ${error.message}`);
          })
          .finally(() => {
            this.hideLoader();
            this.elements.uploadProgress.textContent = '';
            // ボタンの状態は resetFileInput で制御される
          });
        };
        reader.onerror = (error) => {
          console.error('ファイル読み込み失敗:', error);
          this.showErrorMessage('ファイルの読み込みに失敗しました。');
          this.hideLoader();
          this.elements.uploadProgress.textContent = '';
          this.elements.uploadImageBtn.disabled = false; // 失敗したら再度有効化
        };
        reader.readAsDataURL(file); // Base64で読み込む
      },

       // 指定した段階の画像識別子(URL or File ID)をconfigに設定し、UIを更新する
      setImageIdentifier: function(stageIndex, identifier) {
           // images配列の長さを確認して拡張
           while (this.config.images.length <= stageIndex) {
               this.config.images.push('');
           }
           this.config.images[stageIndex] = identifier;
           this.updateImageGrid(); // 画像グリッドを更新して反映
       },


      // すべての設定をGASに保存する
      saveSettings: function() {
        this.config.apiUrl = this.elements.apiUrlInput.value.trim();
        // stages配列の内容を input 要素から最新化 (念のため)
        const stageInputs = document.querySelectorAll('.stage-input');
        stageInputs.forEach(input => {
          const stage = parseInt(input.dataset.stage);
          let value = parseInt(input.value) || 0;
          if (value < 0) value = 0;
           // 配列の長さを確認して拡張
          while (this.config.stages.length <= stage) {
              this.config.stages.push(0);
          }
          this.config.stages[stage] = value;
        });
        // Stage 0 は常に 0
        this.config.stages[0] = 0;

        // images配列は uploadAndSaveImage または setIdUrlBtn で更新済みのはず

        console.log('保存する設定:', this.config);
        this.showLoader('設定を保存中...');

        fetch(this.config.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // 注意: images配列に非常に長いData URLが含まれていると、POSTリクエストのサイズ制限に抵触する可能性がある
          // Drive ID方式ならこの問題はほぼ発生しない
          body: JSON.stringify({
            action: 'saveConfig',
            config: {
                apiUrl: this.config.apiUrl, // API URL自体も保存する場合
                stages: this.config.stages,
                images: this.config.images
            }
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            this.showSuccessMessage(data.message || 'すべての設定が保存されました！メイン画面に反映されます。');
            localStorage.setItem('treeAppApiUrl', this.config.apiUrl); // API URLをローカルストレージに保存
          } else {
            throw new Error(data.message || '設定の保存中に不明なエラーが発生しました。');
          }
        })
        .catch(error => {
          console.error('保存エラー:', error);
          this.showErrorMessage(`設定の保存に失敗しました: ${error.message}`);
        })
        .finally(() => {
          this.hideLoader();
        });
      },

      showLoader: function(message = '') {
        this.elements.loader.style.display = 'block';
        if (message) {
            this.elements.uploadProgress.textContent = message; // ローダーとメッセージ表示を兼用
        }
      },
      hideLoader: function() {
        this.elements.loader.style.display = 'none';
         if (!this.selectedFile) { // アップロード中でなければメッセージも消す
            this.elements.uploadProgress.textContent = '';
        }
      },

      showSuccessMessage: function(message) {
        this.elements.successMessage.textContent = message;
        this.elements.successMessage.style.display = 'block';
        this.elements.errorMessage.style.display = 'none';
        setTimeout(() => {
          this.elements.successMessage.style.display = 'none';
        }, 4000); // 少し長めに表示
      },

      showErrorMessage: function(message) {
        this.elements.errorMessage.textContent = message;
        this.elements.errorMessage.style.display = 'block';
        this.elements.successMessage.style.display = 'none';
        // エラーメッセージは自動で消さない、または長めに表示
        setTimeout(() => {
           this.elements.errorMessage.style.display = 'none';
        }, 8000);
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      adminApp.init();
    });
  </script>
</body>
</html>
