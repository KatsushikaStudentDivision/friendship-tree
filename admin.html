<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>友情の木 - 管理画面</title>
  <style>
    /* 基本スタイル */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; background-color: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
    h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eaeaea; padding-bottom: 15px; }
    .form-section { margin-bottom: 30px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50; }
    h2 { margin-bottom: 15px; color: #2c3e50; font-size: 1.4em; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="url"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
    input[type="file"] { display: block; margin-top: 5px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white; }
    button { padding: 12px 20px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
    button:hover:not(:disabled) { background-color: #388e3c; } /* ホバー効果を無効でないボタンに限定 */
    button:disabled { background-color: #ccc; cursor: not-allowed; } /* disabledスタイル追加 */
    .buttons { display: flex; justify-content: space-between; margin-top: 20px; flex-wrap: wrap; gap: 10px;} /* ボタン折り返し対応 */
    .preview-btn { background-color: #2196f3; }
    .preview-btn:hover:not(:disabled) { background-color: #1976d2; }
    .home-btn { background-color: #9e9e9e; }
    .home-btn:hover:not(:disabled) { background-color: #757575; }
    .image-manager { margin-top: 20px; }
    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .image-item { border: 1px solid #ddd; border-radius: 4px; padding: 10px; text-align: center; position: relative; background-color: #fff;}
    .image-item img { max-width: 100%; height: auto; display: block; margin: 5px auto; min-height: 100px; object-fit: contain; background-color:#f0f0f0; } /* min-height, object-fit, margin調整 */
    .image-item .stage-number { font-weight: bold; margin-bottom: 5px;}
    .image-upload { margin-bottom: 10px; padding: 15px; background-color: #e8f5e9; border-radius: 4px; border: 1px solid #c8e6c9; }
    .success-message { background-color: #e8f5e9; color: #388e3c; padding: 15px; margin-top: 20px; border-radius: 4px; text-align: center; display: none; border: 1px solid #a5d6a7;}
    .error-message { background-color: #ffebee; color: #d32f2f; padding: 15px; margin-top: 20px; border-radius: 4px; text-align: center; display: none; border: 1px solid #ef9a9a;}
    footer { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 0.9rem; }
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4caf50; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; } /* スピード調整 */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .stage-settings { margin-top: 20px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
    .stage-settings-header { display: grid; grid-template-columns: 100px 1fr; background-color: #f1f8e9; padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; }
    .stage-row { display: grid; grid-template-columns: 100px 1fr; padding: 8px 10px; border-bottom: 1px solid #eee; align-items: center;} /* align-items追加 */
    .stage-row:nth-child(even) { background-color: #f9f9f9; }
    .stage-row:last-child { border-bottom: none; }
    .stage-input { width: 100%; max-width: 150px; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;} /* font-size調整 */
    .btn-small { padding: 5px 10px; font-size: 14px; margin-left: 10px; vertical-align: middle;} /* vertical-align追加 */
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; flex-wrap: wrap; } /* flex-wrap追加 */
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 4px 4px 0 0; margin-right: 5px; background-color: #e9e9e9; color: #555;}
    .tab.active { background-color: #fff; border-color: #ddd; border-bottom-color: #fff; margin-bottom: -1px; font-weight: bold; color: #333;}
    .tab-content { display: none; padding-top: 20px; border-top: 1px solid #ddd;}
    .tab-content.active { display: block; }
    .file-info { font-size: 0.9em; color: #555; margin-top: 5px; min-height: 1.2em;} /* min-height追加 */
    .upload-progress { margin-top: 10px; font-style: italic; color: #388e3c;}
    small { display: block; margin-top: 4px; font-size: 0.85em; color: #666; } /* smallタグ調整 */
    .debug-info { margin-top: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; display: none; }
    .advanced-settings { margin-top: 15px; padding: 10px; background-color: #fff8e1; border-radius: 4px; border: 1px solid #ffe082; }
    .btn-inline { display: inline-block; margin-right: 5px; margin-top: 5px; }
    
    /* リスポンシブ対応 */
    @media (max-width: 768px) {
      .container { padding: 15px; }
      h1 { font-size: 22px; margin-bottom: 20px; }
      .form-section { padding: 15px; }
      .buttons { flex-direction: column; }
      .buttons button { width: 100%; margin: 5px 0; }
    }
    
    @media (max-width: 480px) {
      h1 { font-size: 18px; }
      .tabs { flex-direction: column; }
      .tab { margin-bottom: 2px; border-radius: 4px; }
      .tab.active { border-bottom-color: #ddd; }
      .stage-settings-header, .stage-row { grid-template-columns: 80px 1fr; }
      .image-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>友情の木 - 管理画面</h1>

    <div class="tabs">
      <div class="tab active" data-tab="basic-settings">基本設定</div>
      <div class="tab" data-tab="stage-settings">成長段階設定</div>
      <div class="tab" data-tab="image-settings">画像設定</div>
    </div>

    <div id="basic-settings" class="tab-content active">
      <div class="form-section">
        <h2>基本設定</h2>
        <div class="form-group">
          <label for="api-url">Google Apps Script API URL:</label>
          <input type="url" id="api-url" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec">
          <small>※ GASをWebアプリとしてデプロイしたURLを入力し、「すべての設定を保存」を押してください。</small>
        </div>
        
        <div class="advanced-settings">
          <h3>詳細設定</h3>
          <div class="form-group">
            <button id="test-connection-btn" class="btn-inline">接続テスト</button>
            <button id="save-stages-only-btn" class="btn-inline">成長段階のみ保存</button>
            <button id="save-images-only-btn" class="btn-inline">画像設定のみ保存</button>
            <button id="clear-all-images-btn" class="btn-inline" style="background-color: #ff5722;">全画像URLをクリア</button>
          </div>
          <div class="form-group">
            <input type="checkbox" id="debug-mode" style="width: auto; vertical-align: middle;">
            <label for="debug-mode" style="display: inline-block; font-weight: normal;">デバッグモード (詳細なエラー情報を表示)</label>
          </div>
          <div id="debug-info" class="debug-info"></div>
        </div>
      </div>
    </div>

    <div id="stage-settings" class="tab-content">
      <div class="form-section">
        <h2>成長段階の設定</h2>
        <p>各成長段階に到達するために必要な「友達との交流回数」の合計値を設定します。</p>

        <div class="stage-settings">
          <div class="stage-settings-header">
            <div>成長段階</div>
            <div>必要な交流回数 (以上)</div>
          </div>
          <div id="stage-rows-container">
            </div>
        </div>

        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <button id="reset-stages-btn" class="btn-small" style="background-color: #ff9800;">初期値にリセット</button>
                <button id="auto-distribute-btn" class="btn-small" style="background-color: #2196f3;">均等に自動設定</button>
            </div>
            <div class="form-group" style="margin-bottom: 0;"> <label for="max-meetings" style="display: inline-block; margin-right: 5px; margin-bottom: 0;">最大交流回数:</label>
              <input type="number" id="max-meetings" placeholder="例: 150" min="1" value="150" style="width: 80px; display: inline-block; padding: 5px 8px;">
              <small style="display: inline;">※自動設定時に使用</small>
            </div>
        </div>
        <small>※ 設定変更後は「すべての設定を保存」を押してください。<br>※ エラーが出る場合は「成長段階のみ保存」ボタンを試してください。</small>
      </div>
    </div>

    <div id="image-settings" class="tab-content">
      <div class="form-section">
        <h2>成長段階の画像設定</h2>
        <p>30段階の成長に対応する画像を設定します。画像をアップロードするか、既存のURLやGoogle DriveファイルIDを指定してください。</p>

        <div class="image-upload">
          <label for="stage-selector">設定/変更する成長段階:</label>
          <select id="stage-selector">
            </select>

          <div class="form-group" style="margin-top: 15px;">
             <label for="image-upload-input">新しい画像をアップロード:</label>
             <input type="file" id="image-upload-input" accept="image/png, image/jpeg, image/gif">
             <div id="file-info" class="file-info"></div>
             <button id="upload-image-btn" disabled style="margin-top: 5px;">選択した画像をアップロードして設定</button>
             <div id="upload-progress" class="upload-progress"></div>
             <small>※ 推奨: PNG, JPG, GIF形式。5MB以下推奨。</small>
          </div>

          <p style="text-align: center; margin: 15px 0;">または</p>

          <div class="form-group">
            <label for="image-id-url-input">既存の画像URL または Google Drive ファイルID:</label>
            <input type="text" id="image-id-url-input" placeholder="https://.../image.jpg または DriveのファイルID">
             <button id="set-id-url-btn" style="margin-top: 5px;">入力したURL/IDを設定</button>
             <small>※ Flickr画像の場合は、共有された画像URLを直接入力できます。<br>画像をクリアする場合は入力欄を空にして設定ボタンを押します。</small>
          </div>
           <small>※ 設定変更後は「すべての設定を保存」ボタンまたは「画像設定のみ保存」ボタンを押して確定させてください。</small>
        </div>

        <div class="image-manager">
          <h3>現在の画像設定</h3>
          <div class="image-grid" id="image-grid">
            </div>
        </div>
      </div>
    </div>

    <div class="loader" id="loader"></div>
    <div class="success-message" id="success-message"></div>
    <div class="error-message" id="error-message"></div>

    <div class="buttons">
      <button id="save-settings-btn">すべての設定を保存</button>
      <button id="preview-btn" class="preview-btn">メイン画面をプレビュー</button>
      <button id="home-btn" class="home-btn">メイン画面に戻る</button>
    </div>
  </div>

  <footer>
    友情の木 管理ツール - 設定変更はこの画面から行ってください
  </footer>

  <script>
    const adminApp = {
      config: {
        apiUrl: '', // ローカルストレージまたはデフォルト値から読み込む
        stages: Array(31).fill(0), // 初期値を設定
        images: Array(31).fill('')  // 初期値を設定
      },
      elements: {
        apiUrlInput: document.getElementById('api-url'),
        stageSelector: document.getElementById('stage-selector'),
        imageUploadInput: document.getElementById('image-upload-input'),
        fileInfo: document.getElementById('file-info'),
        uploadImageBtn: document.getElementById('upload-image-btn'),
        imageIdUrlInput: document.getElementById('image-id-url-input'),
        setIdUrlBtn: document.getElementById('set-id-url-btn'),
        uploadProgress: document.getElementById('upload-progress'),
        imageGrid: document.getElementById('image-grid'),
        saveSettingsBtn: document.getElementById('save-settings-btn'),
        previewBtn: document.getElementById('preview-btn'),
        homeBtn: document.getElementById('home-btn'),
        loader: document.getElementById('loader'),
        successMessage: document.getElementById('success-message'),
        errorMessage: document.getElementById('error-message'),
        stageRowsContainer: document.getElementById('stage-rows-container'),
        resetStagesBtn: document.getElementById('reset-stages-btn'),
        autoDistributeBtn: document.getElementById('auto-distribute-btn'),
        maxMeetingsInput: document.getElementById('max-meetings'),
        tabs: document.querySelectorAll('.tab'),
        tabContents: document.querySelectorAll('.tab-content'),
        testConnectionBtn: document.getElementById('test-connection-btn'),
        saveStagesOnlyBtn: document.getElementById('save-stages-only-btn'),
        saveImagesOnlyBtn: document.getElementById('save-images-only-btn'),
        clearAllImagesBtn: document.getElementById('clear-all-images-btn'),
        debugMode: document.getElementById('debug-mode'),
        debugInfo: document.getElementById('debug-info')
      },
      selectedFile: null, // アップロード用に選択されたファイルを保持
      whitePixel: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/wcAAwAB/7+98QAAAABJRU5ErkJggg==', // 白画像データ

      init: function() {
        // API URLをローカルストレージから読み込むか、デフォルト値を使用 (例)
        const savedApiUrl = localStorage.getItem('treeAppApiUrl');
        // ↓ 必要であればデフォルトのウェブアプリURLを設定
        const defaultApiUrl = 'YOUR_DEFAULT_WEB_APP_URL_HERE'; // 例: 'https://script.google.com/macros/s/...'
        this.config.apiUrl = savedApiUrl || defaultApiUrl;
        this.elements.apiUrlInput.value = this.config.apiUrl;

        if (!this.config.apiUrl || this.config.apiUrl === 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
            this.showErrorMessage('API URLが設定されていません。「基本設定」タブで正しいURLを入力し、「すべての設定を保存」を押してください。');
        }

        this.updateStageSelector(); // セレクターを初期化
        this.loadConfig(); // GASから設定を取得 (API URLが設定されていれば)
        this.setupEventListeners();
      },

      loadConfig: function() {
        if (!this.config.apiUrl || this.config.apiUrl === 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
          console.warn('API URL未設定のため、設定読み込みをスキップします。');
          this.updateUI(); // 現在のローカルconfigでUIを更新
          return;
        }

        this.showLoader('設定読み込み中...');
        fetch(this.config.apiUrl + '?action=getConfig')
          .then(response => {
            if (!response.ok) throw new Error(`設定取得APIエラー: ${response.status}`);
            return response.json();
          })
          .then(data => {
            if (data.error) throw new Error(`設定取得エラー: ${data.message}`);

            // stagesとimagesを読み込む（存在しない場合は初期値を維持）
            this.config.stages = (data.stages && Array.isArray(data.stages) && data.stages.length > 0) ? data.stages : this.config.stages;
            this.config.images = (data.images && Array.isArray(data.images)) ? data.images : this.config.images;

            // 配列の長さが足りない場合に備える (31要素 = 0から30まで)
            while (this.config.stages.length < 31) this.config.stages.push(0);
            while (this.config.images.length < 31) this.config.images.push('');
            // 長すぎる場合は切り詰める (任意)
            this.config.stages = this.config.stages.slice(0, 31);
            this.config.images = this.config.images.slice(0, 31);

            console.log('サーバーから設定を読み込みました:', this.config);
            this.updateUI(); // UI全体を更新
            this.showSuccessMessage('設定を読み込みました');
          })
          .catch(error => {
            console.error('設定取得に失敗:', error);
            this.showErrorMessage(`サーバーからの設定取得に失敗しました: ${error.message} API URLを確認してください。`);
            this.updateUI(); // エラー時も現在のローカルconfigでUI表示試みる
          })
          .finally(() => {
            this.hideLoader();
          });
      },

      testConnection: function() {
        if (!this.config.apiUrl || this.config.apiUrl === 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
          this.showErrorMessage('API URLが設定されていません。基本設定タブで設定してください。');
          return;
        }

        this.showLoader('接続テスト中...');
        fetch(this.config.apiUrl + '?action=test')
          .then(response => {
            if (!response.ok) throw new Error(`APIエラー: ${response.status}`);
            return response.json();
          })
          .then(data => {
            this.showSuccessMessage('接続テスト成功！サーバーと正常に通信できています。');
            if (this.elements.debugMode.checked) {
              this.elements.debugInfo.style.display = 'block';
              this.elements.debugInfo.innerHTML = `<strong>サーバー応答:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
          })
          .catch(error => {
            console.error('接続テスト失敗:', error);
            this.showErrorMessage(`接続テスト失敗: ${error.message}`);
          })
          .finally(() => {
            this.hideLoader();
          });
      },

      setupDefaultStages: function() {
        // this.config.stages = []; // しない方が良い、既存の設定を上書きしない
        const maxMeetings = parseInt(this.elements.maxMeetingsInput.value) || 150;
        if (maxMeetings <= 0) {
            this.showErrorMessage('最大交流回数は1以上で設定してください。');
            return []; // 不正な値の場合は空配列を返すなど
        }
        const totalStages = 30;
        const defaultStages = [];
        defaultStages.push(0); // Stage 0 は常に 0
        for (let i = 1; i <= totalStages; i++) {
          const meetingsRequired = Math.max(1, Math.ceil((i / totalStages) * maxMeetings)); // 1以上、切り上げ
          defaultStages.push(meetingsRequired);
        }
        console.log('デフォルトの段階設定を作成:', defaultStages);
        return defaultStages; // 生成した配列を返す
      },

      autoDistributeStages: function() {
        const newStages = this.setupDefaultStages(); // デフォルト値を生成
        if (newStages.length > 0) {
            this.config.stages = newStages; // configに反映
            this.updateStageSettings(); // UI更新
        }
      },

      updateUI: function() {
        // API URLは init で設定済みなのでここでは不要
        // 最大交流回数入力欄の値を更新（現在の設定から）
        this.elements.maxMeetingsInput.value = Math.max(1, ...this.config.stages.slice(1)) || 150; // stage 0 は除き、最低1

        // 常にセレクターは更新しておく
        this.updateStageSelector();

        // 現在アクティブなタブの内容を更新
        const activeTabId = document.querySelector('.tab.active')?.dataset.tab;
        if (activeTabId === 'stage-settings') {
            this.updateStageSettings();
        } else if (activeTabId === 'image-settings') {
            this.updateImageGrid(); // 画像グリッドも更新
        }
      },

      updateStageSelector: function() {
        const selectedValue = this.elements.stageSelector.value;
        this.elements.stageSelector.innerHTML = '';
        for (let i = 0; i <= 30; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `段階 ${i}`;
          this.elements.stageSelector.appendChild(option);
        }
        if (selectedValue && parseInt(selectedValue) >= 0 && parseInt(selectedValue) <= 30) {
          this.elements.stageSelector.value = selectedValue;
        } else {
          this.elements.stageSelector.value = '0'; // デフォルトは0
        }
        // セレクタの値を元に他のUIも更新
        this.handleStageSelectionChange();
      },

       // 段階セレクタの値が変わった時の処理をまとめる
      handleStageSelectionChange: function() {
          this.resetFileInput(); // ファイル選択・入力欄をリセット
          // 選択中の段階の画像ID/URLを入力欄に表示（編集用）
          const stageIndex = parseInt(this.elements.stageSelector.value);
          if(stageIndex >= 0 && stageIndex < this.config.images.length) {
             this.elements.imageIdUrlInput.value = this.config.images[stageIndex] || '';
          } else {
             this.elements.imageIdUrlInput.value = ''; // 範囲外ならクリア
          }
       },

      updateStageSettings: function() {
        this.elements.stageRowsContainer.innerHTML = '';
        if (!this.config.stages || this.config.stages.length < 31) {
             // 配列が不正なら初期化 (長さが足りないなど)
             while(this.config.stages.length < 31) this.config.stages.push(0);
             this.config.stages = this.config.stages.slice(0, 31);
             console.warn("Stages設定配列の長さが不正だったため調整しました。");
        }

        for (let i = 0; i <= 30; i++) {
          const row = document.createElement('div');
          row.className = 'stage-row';
          const stageLabel = document.createElement('div');
          stageLabel.textContent = `段階 ${i}`;
          const inputContainer = document.createElement('div');
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.className = 'stage-input';
          input.value = this.config.stages[i]; // 配列から値を取得
          input.dataset.stage = i;
          // Stage 0 は編集不可にする (任意)
          if (i === 0) {
            input.readOnly = true;
            input.style.backgroundColor = '#eee';
          }

          input.addEventListener('change', (e) => {
            const stage = parseInt(e.target.dataset.stage);
            let value = parseInt(e.target.value) || 0;
            if (value < 0) value = 0;
            // 念のため配列長チェック
            if(stage >= 0 && stage < this.config.stages.length) {
               this.config.stages[stage] = value;
               // Stage 0は常に0
               if (stage === 0) {
                   this.config.stages[0] = 0;
                   e.target.value = 0;
               }
               // TODO: 後の段階より前の段階の値が大きくならないようなバリデーションを追加すると尚良い
            }
          });
          inputContainer.appendChild(input);
          row.appendChild(stageLabel);
          row.appendChild(inputContainer);
          this.elements.stageRowsContainer.appendChild(row);
        }
      },

     updateImageGrid: function() {
        this.elements.imageGrid.innerHTML = '';
        if (!this.config.images || this.config.images.length < 31) {
             // 配列が不正なら初期化
             while(this.config.images.length < 31) this.config.images.push('');
             this.config.images = this.config.images.slice(0, 31);
             console.warn("Images設定配列の長さが不正だったため調整しました。");
        }

        this.config.images.forEach((imageIdentifier, index) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';

          const stageNumber = document.createElement('div');
          stageNumber.className = 'stage-number';
          stageNumber.textContent = `段階 ${index}`;

          const img = document.createElement('img');
          img.alt = `成長段階 ${index} の画像`;

          img.onerror = () => {
              console.warn(`画像読込エラー: Stage ${index}, Identifier: ${imageIdentifier}`);
              img.src = this.whitePixel; // エラー時は白画像
              img.alt = `成長段階 ${index} (画像読込エラー)`;
              img.title = `画像読込エラー: ${imageIdentifier}`;
          };

          if (imageIdentifier) {
            // Flickr URLかどうかを判定
            if (imageIdentifier.includes('flickr.com')) {
              img.src = imageIdentifier;
              img.title = `Flickr URL: ${imageIdentifier.substring(0, 50)}...`;
            }
            // Google Drive File ID かどうかを判定
            else if (imageIdentifier.length > 20 && !imageIdentifier.startsWith('http') && !imageIdentifier.startsWith('data:')) {
              img.src = `https://drive.google.com/uc?export=view&id=${imageIdentifier}`;
              img.title = `Drive ID: ${imageIdentifier}`;
            } else { // 他のURL または Data URL
              img.src = imageIdentifier;
              img.title = `URL: ${imageIdentifier.substring(0, 50)}...`;
            }
          } else {
            img.src = this.whitePixel; // 画像未設定時は白画像
            img.alt = `成長段階 ${index} (画像未設定)`;
            img.title = '画像未設定';
          }

          const editBtn = document.createElement('button');
          editBtn.textContent = '選択して編集';
          editBtn.className = 'btn-small';
          editBtn.addEventListener('click', () => {
            this.elements.stageSelector.value = index;
            this.handleStageSelectionChange(); // セレクタ変更時の処理を呼ぶ
            this.activateTab('image-settings');
            this.elements.imageIdUrlInput.focus();
          });

          imageItem.appendChild(stageNumber);
          imageItem.appendChild(img);
          imageItem.appendChild(editBtn);
          this.elements.imageGrid.appendChild(imageItem);
        });
      },

      activateTab: function(tabId) {
        this.elements.tabs.forEach(tab => tab.classList.remove('active'));
        this.elements.tabContents.forEach(content => content.classList.remove('active'));

        const targetTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        const targetContent = document.getElementById(tabId);

        if (targetTab && targetContent) {
          targetTab.classList.add('active');
          targetContent.classList.add('active');

          // タブ切り替え時に内容を更新
          if (tabId === 'stage-settings') {
            this.updateStageSettings();
          } else if (tabId === 'image-settings') {
            this.updateImageGrid();
          }
        }
      },

      setupEventListeners: function() {
        this.elements.tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            this.activateTab(tab.getAttribute('data-tab'));
          });
        });

        this.elements.apiUrlInput.addEventListener('change', () => {
            this.config.apiUrl = this.elements.apiUrlInput.value.trim();
            // API URL は「設定保存」ボタンで config と一緒に送るのではなく、
            // ローカルストレージに即時保存する方が混乱が少ない
            localStorage.setItem('treeAppApiUrl', this.config.apiUrl);
            this.showSuccessMessage('API URLをブラウザに記憶しました。');
            // 必要なら loadConfig を再実行して接続確認など
            // this.loadConfig();
        });

        this.elements.imageUploadInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file) {
            // ファイルサイズチェック (例: 5MB)
            if (file.size > 5 * 1024 * 1024) {
                this.showErrorMessage('ファイルサイズが大きすぎます (5MB以下にしてください)');
                this.resetFileInput();
                return;
            }
            this.elements.fileInfo.textContent = `選択中: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            this.selectedFile = file;
            this.elements.uploadImageBtn.disabled = false;
            this.elements.imageIdUrlInput.value = ''; // URL/ID入力欄はクリア
          } else {
            this.resetFileInput();
          }
        });

        this.elements.stageSelector.addEventListener('change', () => {
             this.handleStageSelectionChange();
         });

        this.elements.uploadImageBtn.addEventListener('click', () => {
          if (this.selectedFile && this.config.apiUrl && this.config.apiUrl !== 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
            const stageIndex = parseInt(this.elements.stageSelector.value);
            this.uploadAndSaveImage(this.selectedFile, stageIndex);
          } else if (!this.selectedFile) {
            this.showErrorMessage('アップロードする画像ファイルを選択してください。');
          } else {
            this.showErrorMessage('API URLが設定されていません。基本設定タブで設定してください。');
          }
        });

        this.elements.setIdUrlBtn.addEventListener('click', () => {
            const stageIndex = parseInt(this.elements.stageSelector.value);
            const idOrUrl = this.elements.imageIdUrlInput.value.trim();

            if (!idOrUrl) { // 入力が空の場合 -> クリア確認
                 if (this.config.images[stageIndex]) { // 何か設定されていた場合のみ確認
                    if (confirm(`段階 ${stageIndex} の画像をクリアしますか？`)) {
                        this.setImageIdentifier(stageIndex, '');
                        this.showSuccessMessage(`段階 ${stageIndex} の画像をクリアしました。(保存ボタンで確定)`);
                    }
                 }
                 return;
            }

            // 簡単なURL/ID形式チェック (任意)
            if (!idOrUrl.includes('flickr.com') && idOrUrl.includes(' ') || (idOrUrl.startsWith('http') && idOrUrl.indexOf('.') === -1)) {
                if (!confirm("入力された値はURLまたはDrive IDとして正しくない可能性があります。続行しますか？")) {
                    return;
                }
            }

            this.setImageIdentifier(stageIndex, idOrUrl);
            this.showSuccessMessage(`段階 ${stageIndex} にURL/IDを設定しました。(保存ボタンで確定)`);
        });

        this.elements.saveSettingsBtn.addEventListener('click', () => {
          if (!this.config.apiUrl || this.config.apiUrl === 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
              this.showErrorMessage('API URLが設定されていません。基本設定タブで設定してください。');
              return;
          }
          this.saveSettings();
        });

        this.elements.saveStagesOnlyBtn.addEventListener('click', () => {
          if (!this.config.apiUrl || this.config.apiUrl === 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
              this.showErrorMessage('API URLが設定されていません。基本設定タブで設定してください。');
              return;
          }
          this.saveStagesOnly();
        });

        this.elements.saveImagesOnlyBtn.addEventListener('click', () => {
          if (!this.config.apiUrl || this.config.apiUrl === 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
              this.showErrorMessage('API URLが設定されていません。基本設定タブで設定してください。');
              return;
          }
          this.saveImagesOnly();
        });

        this.elements.clearAllImagesBtn.addEventListener('click', () => {
          if (confirm('すべての画像URLをクリアしますか？この操作は元に戻せません。')) {
            this.config.images = Array(31).fill('');
            this.updateImageGrid();
            this.showSuccessMessage('すべての画像URLをクリアしました。(保存ボタンで確定)');
          }
        });

        this.elements.testConnectionBtn.addEventListener('click', () => {
          this.testConnection();
        });

        this.elements.previewBtn.addEventListener('click', () => {
          window.open('index.html', '_blank');
        });

        this.elements.homeBtn.addEventListener('click', () => {
          window.location.href = 'index.html';
        });

        this.elements.resetStagesBtn.addEventListener('click', () => {
          if (confirm('段階設定を初期値に戻しますか？（最大交流回数の値に基づいて計算されます）')) {
            const defaultStages = this.setupDefaultStages();
            if (defaultStages.length > 0) {
                this.config.stages = defaultStages;
                this.updateStageSettings();
                this.showSuccessMessage('段階設定を初期値にリセットしました。(保存ボタンで確定)');
            }
          }
        });

        this.elements.autoDistributeBtn.addEventListener('click', () => {
          this.autoDistributeStages();
          this.showSuccessMessage('段階設定を均等に自動設定しました。(保存ボタンで確定)');
        });

        this.elements.debugMode.addEventListener('change', () => {
          if (!this.elements.debugMode.checked) {
            this.elements.debugInfo.style.display = 'none';
          }
        });
      },

      resetFileInput: function() {
          this.elements.imageUploadInput.value = '';
          this.elements.fileInfo.textContent = '';
          this.selectedFile = null;
          this.elements.uploadImageBtn.disabled = true;
          this.elements.uploadProgress.textContent = '';
          // this.elements.imageIdUrlInput.value = ''; // 段階セレクタ変更時に処理するのでここではクリアしない
      },

      uploadAndSaveImage: function(file, stageIndex) {
        this.showLoader('画像をアップロード中...');
        this.elements.uploadProgress.textContent = 'ファイル読み込み中...';
        this.elements.uploadImageBtn.disabled = true; // 処理中は両方のボタンを無効化
        this.elements.setIdUrlBtn.disabled = true;

        const reader = new FileReader();
        reader.onload = (e) => {
          const base64Data = e.target.result;
          this.elements.uploadProgress.textContent = 'サーバーに送信中...';

          fetch(this.config.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, // 送信データはJSON
            body: JSON.stringify({
              action: 'uploadImage',
              fileData: {
                base64: base64Data, // data:image/...;base64, を含むBase64文字列
                type: file.type,
                name: file.name
              }
            })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.status === 'success' && data.fileId) {
              this.setImageIdentifier(stageIndex, data.fileId);
              this.showSuccessMessage(`段階 ${stageIndex} の画像をアップロード完了！ Drive ID: ${data.fileId} (保存ボタンで確定)`);
              this.resetFileInput();
              this.elements.imageIdUrlInput.value = data.fileId; // 入力欄にもIDを表示
            } else {
              throw new Error(data.message || '画像アップロードに失敗しました。');
            }
          })
          .catch(error => {
            console.error('画像アップロードエラー:', error);
            this.showErrorMessage(`画像アップロード失敗: ${error.message}`);
            this.resetFileInput(); // 失敗時もリセット
          })
          .finally(() => {
            this.hideLoader();
            this.elements.uploadProgress.textContent = '';
            // ボタンの有効/無効は resetFileInput または handleStageSelectionChange で制御される
            this.elements.setIdUrlBtn.disabled = false; // URL/ID設定ボタンは再度有効化
          });
        };
        reader.onerror = (error) => {
          console.error('ファイル読み込み失敗:', error);
          this.showErrorMessage('ファイルの読み込みに失敗しました。');
          this.hideLoader();
          this.elements.uploadProgress.textContent = '';
          this.elements.uploadImageBtn.disabled = false; // 失敗したらアップロードボタンは再度有効化
          this.elements.setIdUrlBtn.disabled = false;
        };
        reader.readAsDataURL(file); // Base64形式で読み込む
      },

      setImageIdentifier: function(stageIndex, identifier) {
        if(stageIndex >= 0 && stageIndex < this.config.images.length) {
          // Flickr URLの場合、余計なパラメータを削除して単純化
          if (identifier && identifier.includes('flickr.com')) {
            // URLからクエリパラメータを削除してシンプルにする（必要に応じて）
            const cleanUrl = identifier.split('?')[0];
            this.config.images[stageIndex] = cleanUrl;
          } else if (identifier) {
            // 他のURLやGoogle Drive IDの処理
            this.config.images[stageIndex] = identifier;
          } else {
            // 空の場合
            this.config.images[stageIndex] = '';
          }
          this.updateImageGrid(); // グリッドを更新して反映
        }
      },

      saveSettings: function() {
        // 設定保存前のコンソール出力
        console.log('API URL:', this.config.apiUrl);
        console.log('保存する設定データ:', JSON.stringify(this.config).length, 'バイト');
        
        this.showLoader('設定を保存中...');
        
        // API URL は config に含めず、stages と images のみ送る
        const configToSave = {
          stages: this.config.stages,
          images: this.config.images
        };

        // フェッチ前のエラーチェック
        if (!this.config.apiUrl) {
          this.showErrorMessage('API URLが設定されていません');
          this.hideLoader();
          return;
        }

        // stages配列の内容を input 要素から最新化
        const stageInputs = document.querySelectorAll('.stage-input');
        stageInputs.forEach(input => {
          const stage = parseInt(input.dataset.stage);
          let value = parseInt(input.value) || 0;
          if (value < 0) value = 0;
          if (stage === 0) value = 0; // Stage 0 は 0
          if(stage >= 0 && stage < this.config.stages.length) {
             this.config.stages[stage] = value;
          }
        });

        // デバッグモードかどうか
        const isDebug = this.elements.debugMode.checked;
        const apiUrl = this.config.apiUrl + (isDebug ? (this.config.apiUrl.includes('?') ? '&' : '?') + 'debug=true' : '');
        
        fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveConfig',
            config: configToSave
          })
        })
        .then(response => {
          console.log('サーバー応答ステータス:', response.status);
          if (!response.ok) {
            throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('サーバー応答データ:', data);
          if (data.status === 'success') {
            this.showSuccessMessage(data.message || 'すべての設定が保存されました！');
            localStorage.setItem('treeAppApiUrl', this.config.apiUrl);
            
            // デバッグ情報表示
            if (isDebug && data.debug) {
              this.elements.debugInfo.style.display = 'block';
              this.elements.debugInfo.innerHTML = `<strong>サーバー応答詳細:</strong><br><pre>${JSON.stringify(data.debug, null, 2)}</pre>`;
            }
          } else {
            throw new Error(data.message || '不明なエラー');
          }
        })
        .catch(error => {
          console.error('保存エラー詳細:', error);
          
          // エラーの種類に応じたメッセージ
          let errorMsg = `設定の保存に失敗しました: ${error.message}`;
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMsg += '（ネットワークエラー - URLとインターネット接続を確認してください）';
          } else if (error.message.includes('NetworkError')) {
            errorMsg += '（CORS制限の可能性があります - GASの設定を確認してください）';
          }
          
          this.showErrorMessage(errorMsg);
          
          // デバッグモードの場合は詳細エラー情報表示
          if (isDebug) {
            this.elements.debugInfo.style.display = 'block';
            this.elements.debugInfo.innerHTML = `<strong>エラー詳細:</strong><br>
                                              <p>${error.toString()}</p>
                                              <p>スタック: ${error.stack}</p>
                                              <p>ヒント: 「成長段階のみ保存」や「画像設定のみ保存」ボタンを試してみてください。</p>`;
          }
        })
        .finally(() => {
          this.hideLoader();
        });
      },

      // 成長段階のみを保存する関数
      saveStagesOnly: function() {
        // stages配列の内容を input 要素から最新化
        const stageInputs = document.querySelectorAll('.stage-input');
        stageInputs.forEach(input => {
          const stage = parseInt(input.dataset.stage);
          let value = parseInt(input.value) || 0;
          if (value < 0) value = 0;
          if (stage === 0) value = 0; // Stage 0 は 0
          if(stage >= 0 && stage < this.config.stages.length) {
             this.config.stages[stage] = value;
          }
        });

        this.showLoader('成長段階設定を保存中...');
        
        // 成長段階のみのconfigを作成
        const configToSave = {
          stages: this.config.stages,
          // imagesは空配列を送信
          images: []
        };
        
        // デバッグモードかどうか
        const isDebug = this.elements.debugMode.checked;
        const apiUrl = this.config.apiUrl + (isDebug ? (this.config.apiUrl.includes('?') ? '&' : '?') + 'debug=true' : '');
        
        fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveConfig',
            config: configToSave,
            saveType: 'stagesOnly'
          })
        })
        .then(response => {
          if (!response.ok) throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            this.showSuccessMessage('成長段階設定を保存しました！');
            
            // デバッグ情報表示
            if (isDebug && data.debug) {
              this.elements.debugInfo.style.display = 'block';
              this.elements.debugInfo.innerHTML = `<strong>サーバー応答詳細:</strong><br><pre>${JSON.stringify(data.debug, null, 2)}</pre>`;
            }
          } else {
            throw new Error(data.message || '不明なエラー');
          }
        })
        .catch(error => {
          console.error('成長段階保存エラー:', error);
          this.showErrorMessage(`成長段階設定の保存に失敗しました: ${error.message}`);
          
          // デバッグモードの場合は詳細エラー情報表示
          if (isDebug) {
            this.elements.debugInfo.style.display = 'block';
            this.elements.debugInfo.innerHTML = `<strong>エラー詳細:</strong><br><p>${error.toString()}</p>`;
          }
        })
        .finally(() => {
          this.hideLoader();
        });
      },

      // 画像設定のみを保存する関数
      saveImagesOnly: function() {
        this.showLoader('画像設定を保存中...');
        
        // 画像設定のみのconfigを作成
        const configToSave = {
          // stagesは空配列を送信
          stages: [],
          images: this.config.images
        };
        
        // デバッグモードかどうか
        const isDebug = this.elements.debugMode.checked;
        const apiUrl = this.config.apiUrl + (isDebug ? (this.config.apiUrl.includes('?') ? '&' : '?') + 'debug=true' : '');
        
        fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveConfig',
            config: configToSave,
            saveType: 'imagesOnly'
          })
        })
        .then(response => {
          if (!response.ok) throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            this.showSuccessMessage('画像設定を保存しました！');
            
            // デバッグ情報表示
            if (isDebug && data.debug) {
              this.elements.debugInfo.style.display = 'block';
              this.elements.debugInfo.innerHTML = `<strong>サーバー応答詳細:</strong><br><pre>${JSON.stringify(data.debug, null, 2)}</pre>`;
            }
          } else {
            throw new Error(data.message || '不明なエラー');
          }
        })
        .catch(error => {
          console.error('画像設定保存エラー:', error);
          this.showErrorMessage(`画像設定の保存に失敗しました: ${error.message}`);
          
          // デバッグモードの場合は詳細エラー情報表示
          if (isDebug) {
            this.elements.debugInfo.style.display = 'block';
            this.elements.debugInfo.innerHTML = `<strong>エラー詳細:</strong><br><p>${error.toString()}</p>`;
          }
        })
        .finally(() => {
          this.hideLoader();
        });
      },

      showLoader: function(message = '') {
        this.elements.loader.style.display = 'block';
        // ボタン類を無効化
        this.elements.saveSettingsBtn.disabled = true;
        this.elements.uploadImageBtn.disabled = true;
        this.elements.setIdUrlBtn.disabled = true;
        if (message) {
            this.elements.uploadProgress.textContent = message;
        }
      },
      hideLoader: function() {
        this.elements.loader.style.display = 'none';
        // ボタン類を再度有効化
        this.elements.saveSettingsBtn.disabled = false;
        // uploadImageBtn は selectedFile がある場合のみ有効になるよう resetFileInput で制御
        this.elements.setIdUrlBtn.disabled = false;
        if (!this.selectedFile) { // アップロード中でなければメッセージも消す
            this.elements.uploadProgress.textContent = '';
        }
      },

      showSuccessMessage: function(message) {
        this.elements.successMessage.textContent = message;
        this.elements.successMessage.style.display = 'block';
        this.elements.errorMessage.style.display = 'none';
        setTimeout(() => {
          this.elements.successMessage.style.display = 'none';
        }, 4000);
      },

      showErrorMessage: function(message) {
        this.elements.errorMessage.textContent = message;
        this.elements.errorMessage.style.display = 'block';
        this.elements.successMessage.style.display = 'none';
        setTimeout(() => {
           this.elements.errorMessage.style.display = 'none';
        }, 8000);
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      adminApp.init();
    });
  </script>
</body>
</html>
