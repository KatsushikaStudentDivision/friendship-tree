<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>みんなで育てる友情の木</title>
  <style>
    /* お好みのスタイル */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f8f9fa; display: flex; flex-direction: column; min-height: 100vh; align-items: center; justify-content: center; }
    .container { max-width: 800px; width: 100%; text-align: center; padding: 20px; }
    h1 { color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
    .tree-container { background-color: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px; position: relative; width: 100%; max-width: 500px; aspect-ratio: 1 / 1; overflow: hidden; }
    .tree-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 1.5s ease-in-out; object-fit: contain; }
    .tree-image.active { opacity: 1; }
    .growth-info { margin-top: 20px; padding: 10px; background-color: #e8f5e9; border-radius: 8px; display: inline-block; }
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #4caf50; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-message { color: #d32f2f; background-color: #ffebee; padding: 10px; border-radius: 4px; margin-top: 10px; display: none; }
    footer { margin-top: 20px; color: #7f8c8d; font-size: 12px; text-align: center; padding: 10px; }
    .admin-link { position: fixed; bottom: 5px; right: 5px; color: #ccc; font-size: 10px; text-decoration: none; }
    .admin-link:hover { color: #999; }
  </style>
</head>
<body>
  <div class="container">
    <h1>みんなで育てる友情の木</h1>
    
    <div class="tree-container" id="tree-container">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>データを取得中...</p>
      </div>
      <!-- 画像はJavaScriptで動的に追加されます -->
    </div>
    
    <div class="growth-info" id="growth-info">
      <p>成長段階: <span id="stage-display">0</span>/30</p>
      <p>友達との交流回数: <span id="total-value-display">0</span></p>
    </div>
    
    <div class="error-message" id="error-message"></div>
  </div>
  
  <footer>
    みんなの友情で育つ木 - クラスプロジェクト
  </footer>
  
  <a href="admin.html" class="admin-link">管理</a>
  
  <script>
    const treeApp = {
      config: {
        // GASのWebアプリURL（※ 管理画面と同じURLにしてください）
        apiUrl: 'https://script.google.com/macros/s/AKfycbxw-ITipmUlzBCtYet9Ve5cs59dhXGcqxR87gNnMGVgGmjQ4xTppQzTG_nrydkKund_Yg/exec',
        stages: [],
        images: []
      },
      data: {
        totalMeetings: 0,
        currentStage: 0,
        apiResponse: null
      },
      elements: {
        treeContainer: document.getElementById('tree-container'),
        loading: document.getElementById('loading'),
        stageDisplay: document.getElementById('stage-display'),
        totalValueDisplay: document.getElementById('total-value-display'),
        errorMessage: document.getElementById('error-message')
      },
      imageElements: [],
      animationInProgress: false,
      animationComplete: false,
      
      init: function() {
        this.loadConfig(); // GASから設定（画像URLなど）を取得
        this.fetchData();  // スプレッドシートのデータを取得
        setInterval(() => this.fetchData(), 30000);
      },
      
      // GASから設定取得（GET with action=getConfig）
      loadConfig: function() {
        if (this.config.apiUrl) {
          fetch(this.config.apiUrl + '?action=getConfig')
            .then(response => response.json())
            .then(data => {
              this.config = { ...this.config, ...data };
              console.log('サーバーから設定を読み込みました:', this.config);
              if (!this.config.stages || !Array.isArray(this.config.stages) || this.config.stages.length === 0) {
                this.setupDefaultStages();
              }
              if (!this.config.images || !Array.isArray(this.config.images) || this.config.images.length === 0) {
                this.setupDefaultImages();
              }
              this.updateDisplay();
            })
            .catch(error => {
              console.error('設定取得に失敗:', error);
              this.showError('サーバーからの設定取得に失敗しました');
            });
        }
      },
      
      setupDefaultStages: function() {
        this.config.stages = [];
        const maxMeetings = 150;
        const totalStages = 30;
        for (let i = 0; i <= totalStages; i++) {
          const meetingsRequired = Math.floor((i / totalStages) * maxMeetings);
          this.config.stages.push(meetingsRequired);
        }
        console.log('デフォルトの段階設定を作成しました');
      },
      
      setupDefaultImages: function() {
        this.config.images = [];
        for (let i = 0; i <= 30; i++) {
          this.config.images.push(`https://via.placeholder.com/500x500.png?text=Growth+Stage+${i}`);
        }
        console.log('デフォルトの画像設定を作成しました');
      },
      
      // スプレッドシートからデータを取得（GET with action=getData）
      fetchData: function() {
        this.elements.loading.style.display = 'block';
        this.hideError();
        if (this.config.apiUrl) {
          fetch(this.config.apiUrl + '?action=getData')
            .then(response => {
              if (!response.ok) {
                throw new Error(`APIレスポンスエラー: ${response.status} ${response.statusText}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.error) {
                throw new Error(`APIエラー: ${data.message}`);
              }
              console.log('APIからデータ取得:', data);
              this.data.apiResponse = data;
              this.data.totalMeetings = data.totalMeetings || 0;
              this.calculateStage();
              this.updateDisplay();
              const oldStage = parseInt(this.elements.stageDisplay.textContent) || 0;
              if (!this.animationComplete || oldStage !== this.data.currentStage) {
                this.startGrowthAnimation();
              }
            })
            .catch(error => {
              console.error('データ取得失敗:', error);
              this.showError(`データ取得に失敗: ${error.message}`);
              this.useDemoData();
            })
            .finally(() => {
              this.elements.loading.style.display = 'none';
            });
        } else {
          console.log('API URL未設定：デモデータ使用');
          this.useDemoData();
          this.elements.loading.style.display = 'none';
        }
      },
      
      useDemoData: function() {
        this.data.totalMeetings = Math.floor(Math.random() * 150);
        this.calculateStage();
        this.updateDisplay();
        if (!this.animationComplete) {
          this.startGrowthAnimation();
        } else {
          this.showFinalStage();
        }
      },
      
      calculateStage: function() {
        const meetingsCount = this.data.totalMeetings;
        let newStage = 0;
        console.log(`交流回数: ${meetingsCount}`);
        for (let i = 0; i < this.config.stages.length; i++) {
          const requiredMeetings = this.config.stages[i];
          if (meetingsCount >= requiredMeetings) {
            newStage = i;
          } else {
            break;
          }
        }
        this.data.currentStage = newStage;
        console.log(`段階: ${newStage}`);
      },
      
      updateDisplay: function() {
        this.elements.stageDisplay.textContent = this.data.currentStage;
        this.elements.totalValueDisplay.textContent = this.data.totalMeetings;
      },
      
      startGrowthAnimation: function() {
        this.animationComplete = false;
        this.animationInProgress = false;
        this.elements.treeContainer.querySelectorAll('.tree-image').forEach(img => img.remove());
        this.imageElements = [];
        for (let i = 0; i <= this.data.currentStage; i++) {
          const img = document.createElement('img');
          img.src = this.config.images[i] || `https://via.placeholder.com/500x500.png?text=Growth+Stage+${i}`;
          img.alt = `成長段階 ${i}`;
          img.className = 'tree-image';
          this.elements.treeContainer.appendChild(img);
          this.imageElements.push(img);
        }
        this.showSlide(0);
      },
      
      showFinalStage: function() {
        this.elements.treeContainer.querySelectorAll('.tree-image').forEach(img => img.remove());
        const img = document.createElement('img');
        img.src = this.config.images[this.data.currentStage] || `https://via.placeholder.com/500x500.png?text=Growth+Stage+${this.data.currentStage}`;
        img.alt = `成長段階 ${this.data.currentStage}`;
        img.className = 'tree-image active';
        this.elements.treeContainer.appendChild(img);
      },
      
      showSlide: function(index) {
        if (this.animationInProgress) {
          setTimeout(() => this.showSlide(index), 100);
          return;
        }
        this.animationInProgress = true;
        this.imageElements.forEach(img => img.classList.remove('active'));
        if (this.imageElements[index]) {
          this.imageElements[index].classList.add('active');
        }
        if (index < this.imageElements.length - 1) {
          this.animationInProgress = false;
          setTimeout(() => this.showSlide(index + 1), 2000);
        } else {
          this.animationInProgress = false;
          this.animationComplete = true;
          console.log('スライドショー終了');
        }
      },
      
      showError: function(message) {
        this.elements.errorMessage.textContent = message;
        this.elements.errorMessage.style.display = 'block';
      },
      hideError: function() {
        this.elements.errorMessage.style.display = 'none';
      }
    };
    
    document.addEventListener('DOMContentLoaded', function() {
      treeApp.init();
    });
  </script>
</body>
</html>
