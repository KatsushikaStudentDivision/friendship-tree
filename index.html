<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>友情の木 - 管理画面</title>
    <style>
        /* 基本スタイル & CSSカスタムプロパティ */
        :root {
            --primary-color: #4caf50;
            --primary-dark-color: #388e3c;
            --secondary-color: #2196f3;
            --secondary-dark-color: #1976d2;
            --danger-color: #ff5722;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-bg-color: #f8f9fa;
            --border-color: #ddd;
            --border-color-light: #eee;
            --text-color: #333;
            --text-muted-color: #555;
            --text-light-color: #7f8c8d;
            --white-color: #fff;
            --disabled-bg-color: #ccc;
            --success-bg-color: #e8f5e9;
            --success-text-color: #388e3c;
            --success-border-color: #a5d6a7;
            --error-bg-color: #ffebee;
            --error-text-color: #d32f2f;
            --error-border-color: #ef9a9a;
            --debug-bg-color: #f8f9fa;
            --debug-border-color: #ddd;
            --advanced-bg-color: #fff8e1;
            --advanced-border-color: #ffe082;
            --tab-bg-color: #e9e9e9;
            --tab-active-bg-color: var(--white-color);
            --font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        /* 基本リセット */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: #f0f4f8;
            padding: 20px;
            color: var(--text-color);
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--white-color);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color-light);
            padding-bottom: 15px;
            font-size: 1.8em;
        }
        h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.4em;
            border-bottom: 1px solid var(--border-color-light);
            padding-bottom: 8px;
        }
        h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.2em;
        }

        /* Form Elements */
        .form-section {
            margin-bottom: 30px;
            background-color: var(--light-bg-color);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        .form-group { margin-bottom: 15px; }
        fieldset {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        legend {
            font-weight: bold;
            padding: 0 10px;
            color: var(--text-muted-color);
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-muted-color);
        }
        input[type="text"],
        input[type="url"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            line-height: 1.5;
        }
        input[type="file"] {
            display: block;
            margin-top: 5px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--white-color);
            width: 100%;
        }
        input[type="checkbox"] {
            width: auto;
            vertical-align: middle;
            margin-right: 5px;
        }
        label.inline-label { /* チェックボックス用 */
             display: inline-block;
             font-weight: normal;
             margin-bottom: 0;
        }
        small, .form-hint { /* form-hintクラス追加 */
            display: block;
            margin-top: 4px;
            font-size: 0.85em;
            color: #666;
        }
        .file-info {
            font-size: 0.9em;
            color: var(--text-muted-color);
            margin-top: 5px;
            min-height: 1.2em;
        }
        .upload-progress {
            margin-top: 10px;
            font-style: italic;
            color: var(--success-text-color);
        }

        /* Buttons */
        button, .button { /* .buttonクラスも追加 */
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, opacity 0.3s;
            text-align: center;
            text-decoration: none; /* for .button */
            display: inline-block; /* for .button */
        }
        button:hover:not(:disabled), .button:hover { background-color: var(--primary-dark-color); }
        button:disabled { background-color: var(--disabled-bg-color); cursor: not-allowed; opacity: 0.7;}
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .button-group { /* ボタンをまとめる場合 */
             display: flex;
             flex-wrap: wrap;
             gap: 10px;
             margin-top: 10px;
             margin-bottom: 10px;
        }
        .btn-preview { background-color: var(--secondary-color); }
        .btn-preview:hover:not(:disabled) { background-color: var(--secondary-dark-color); }
        .btn-home { background-color: #9e9e9e; }
        .btn-home:hover:not(:disabled) { background-color: #757575; }
        .btn-small { padding: 5px 10px; font-size: 14px; vertical-align: middle; }
        .btn-warning { background-color: var(--warning-color); }
        .btn-warning:hover:not(:disabled) { background-color: #fb8c00; }
        .btn-info { background-color: var(--info-color); }
        .btn-info:hover:not(:disabled) { background-color: #1976d2; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover:not(:disabled) { background-color: #f4511e; }
        .btn-inline { /* インライン配置のボタングループ */
            display: inline-block;
            margin-right: 5px;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap; /* 折り返し */
            gap: 5px; /* タブ間の隙間 */
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: var(--tab-bg-color);
            color: var(--text-muted-color);
            transition: background-color 0.3s, border-color 0.3s;
            margin-bottom: -1px; /* active時に下の線を重ねる */
        }
        .tab.active {
            background-color: var(--tab-active-bg-color);
            border-color: var(--border-color);
            border-bottom-color: var(--tab-active-bg-color);
            font-weight: bold;
            color: var(--text-color);
        }
        .tab-content { display: none; padding-top: 20px; border-top: 1px solid var(--border-color);}
        .tab-content.active { display: block; }

        /* Stage Settings */
        .stage-settings { margin-top: 20px; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
        .stage-settings-header {
            display: grid;
            grid-template-columns: 100px 1fr;
            background-color: #f1f8e9;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
        }
        .stage-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color-light);
            align-items: center;
        }
        .stage-row:nth-child(even) { background-color: #f9f9f9; }
        .stage-row:last-child { border-bottom: none; }
        .stage-input {
            width: 100%;
            max-width: 150px;
            padding: 5px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }
        .stage-input[readonly] {
            background-color: #eee;
            cursor: not-allowed;
        }
        .stage-actions { /* Stage設定のアクションボタン用 */
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .max-meetings-group { /* 最大交流回数用 */
             margin-bottom: 0;
             display: flex;
             align-items: center;
             gap: 5px;
        }
        .max-meetings-input {
             width: 80px;
             display: inline-block; /* inputをinline-blockに */
             padding: 5px 8px;
        }

        /* Image Settings */
        .image-upload {
            margin-bottom: 10px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
        }
        .image-manager { margin-top: 20px; }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .image-item {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            position: relative;
            background-color: var(--white-color);
        }
        .image-item img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto 5px auto; /* 上下のマージン調整 */
            min-height: 100px;
            object-fit: contain;
            background-color: #f0f0f0;
            border: 1px solid var(--border-color-light);
        }
        .image-item .stage-number { font-weight: bold; margin-bottom: 5px;}
        .image-item .image-identifier { /* 追加: ID/URL表示用 */
             font-size: 0.8em;
             color: var(--text-muted-color);
             word-break: break-all; /* 長い場合に折り返す */
             margin-top: 5px;
             min-height: 2.4em; /* 2行分確保 */
        }
        .image-item .edit-button-wrapper { /* 追加: ボタン用 */
             margin-top: 10px;
        }

        /* Messages & Loader */
        .message { /* 共通メッセージスタイル */
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            text-align: center;
            display: none;
            border: 1px solid transparent;
        }
        .success-message {
            background-color: var(--success-bg-color);
            color: var(--success-text-color);
            border-color: var(--success-border-color);
        }
        .error-message {
            background-color: var(--error-bg-color);
            color: var(--error-text-color);
            border-color: var(--error-border-color);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Advanced & Debug */
        .advanced-settings {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--advanced-bg-color);
            border-radius: 4px;
            border: 1px solid var(--advanced-border-color);
        }
        .debug-info {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--debug-bg-color);
            border: 1px solid var(--debug-border-color);
            border-radius: 4px;
            font-size: 12px;
            display: none; /* JSで制御 */
            word-break: break-all;
            white-space: pre-wrap; /* 改行を保持 */
        }

        /* Footer */
        footer {
            margin-top: 40px;
            text-align: center;
            color: var(--text-light-color);
            font-size: 0.9rem;
        }

        /* Helper Classes */
        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5em; margin-bottom: 20px; }
            .form-section { padding: 15px; }
            .buttons { flex-direction: column; }
            .buttons button, .buttons .button { width: 100%; margin: 5px 0; }
            .stage-actions { flex-direction: column; align-items: stretch; }
            .max-meetings-group { justify-content: space-between; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.3em; }
            .tabs { flex-direction: column; }
            .tab { border-radius: 4px; margin-bottom: 2px;}
            .tab.active { border-bottom-color: var(--border-color); }
            .stage-settings-header, .stage-row { grid-template-columns: 80px 1fr; padding: 8px; }
            .image-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
            .btn-small { width: 100%; margin-top: 5px; } /* 画像編集ボタンなど */
            .image-item .edit-button-wrapper { margin-top: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>友情の木 - 管理画面</h1>

        <div class="tabs">
            <div class="tab active" data-tab="basic-settings">基本設定</div>
            <div class="tab" data-tab="stage-settings">成長段階設定</div>
            <div class="tab" data-tab="image-settings">画像設定</div>
        </div>

        <section id="basic-settings" class="tab-content active">
            <form id="basic-settings-form" onsubmit="return false;"> <div class="form-section">
                    <h2>基本設定</h2>
                    <div class="form-group">
                        <label for="api-url">Google Apps Script API URL:</label>
                        <input type="url" id="api-url" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec">
                        <small class="form-hint">GASをWebアプリとしてデプロイしたURLを入力し、右下の「すべての設定を保存」を押してください。URLはブラウザに記憶されます。</small>
                    </div>

                    <div class="advanced-settings">
                        <h3>詳細・デバッグ</h3>
                        <div class="button-group">
                            <button type="button" id="test-connection-btn" class="btn-inline btn-info">接続テスト</button>
                            <button type="button" id="save-stages-only-btn" class="btn-inline">成長段階のみ保存</button>
                            <button type="button" id="save-images-only-btn" class="btn-inline">画像設定のみ保存</button>
                            <button type="button" id="clear-all-images-btn" class="btn-inline btn-danger">全画像URLをクリア</button>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="debug-mode">
                            <label for="debug-mode" class="inline-label">デバッグモード (詳細情報をコンソールやメッセージ欄に表示)</label>
                        </div>
                        <div id="debug-info" class="debug-info" aria-live="polite"></div>
                    </div>
                </div>
            </form>
        </section>

        <section id="stage-settings" class="tab-content">
             <form id="stage-settings-form" onsubmit="return false;">
                <div class="form-section">
                    <h2>成長段階の設定</h2>
                    <p class="form-hint">各成長段階に到達するために必要な「友達との交流回数」の合計値を設定します。(段階0は常に0回)</p>

                    <div class="stage-settings">
                        <div class="stage-settings-header">
                            <div>成長段階</div>
                            <div>必要な交流回数 (以上)</div>
                        </div>
                        <div id="stage-rows-container">
                            </div>
                    </div>

                    <div class="stage-actions">
                        <div class="button-group">
                            <button type="button" id="reset-stages-btn" class="btn-small btn-warning">初期値にリセット</button>
                            <button type="button" id="auto-distribute-btn" class="btn-small btn-info">均等に自動設定</button>
                        </div>
                        <div class="max-meetings-group">
                            <label for="max-meetings" class="inline-label">最大交流回数:</label>
                            <input type="number" id="max-meetings" class="max-meetings-input" placeholder="例: 150" min="1" value="150">
                            <small class="form-hint">(自動設定時に使用)</small>
                        </div>
                    </div>
                    <small class="form-hint">※ 設定変更後は画面右下の「すべての設定を保存」または「成長段階のみ保存」を押してください。</small>
                </div>
            </form>
        </section>

        <section id="image-settings" class="tab-content">
            <form id="image-settings-form" onsubmit="return false;">
                <div class="form-section">
                    <h2>成長段階の画像設定</h2>
                    <p class="form-hint">30段階の成長に対応する画像を設定します。画像をアップロードするか、既存のURLやGoogle DriveファイルIDを指定してください。</p>

                    <fieldset class="image-upload">
                        <legend>画像の新規設定・変更</legend>
                        <div class="form-group">
                            <label for="stage-selector">対象の成長段階:</label>
                            <select id="stage-selector">
                                </select>
                        </div>

                        <div class="form-group">
                            <label for="image-upload-input">新しい画像をアップロード:</label>
                            <input type="file" id="image-upload-input" accept="image/png, image/jpeg, image/gif">
                            <div id="file-info" class="file-info"></div>
                            <button type="button" id="upload-image-btn" disabled class="btn-small">選択した画像をアップロードして設定</button>
                            <div id="upload-progress" class="upload-progress" aria-live="polite"></div>
                            <small class="form-hint">※ 推奨: PNG, JPG, GIF形式。5MB以下。</small>
                        </div>

                        <p style="text-align: center; margin: 15px 0;">または</p>

                        <div class="form-group">
                            <label for="image-id-url-input">既存の画像URL または Google Drive ファイルID:</label>
                            <input type="text" id="image-id-url-input" placeholder="https://.../image.jpg または DriveのファイルID">
                            <button type="button" id="set-id-url-btn" class="btn-small">入力したURL/IDを設定</button>
                            <small class="form-hint">※ Flickr画像の場合は、共有された画像URLを直接入力できます。<br>画像をクリアする場合は入力欄を空にして設定ボタンを押します。</small>
                        </div>
                        <small class="form-hint">※ 設定変更後は画面右下の「すべての設定を保存」ボタンまたは「画像設定のみ保存」ボタンを押して確定させてください。</small>
                    </fieldset>

                    <div class="image-manager">
                        <h3>現在の画像設定プレビュー</h3>
                        <div class="image-grid" id="image-grid">
                            </div>
                    </div>
                </div>
            </form>
        </section>

        <div class="loader hidden" id="loader" aria-live="polite" aria-label="処理中"></div>
        <div id="message-area"> <div class="message success-message hidden" id="success-message" role="status" aria-live="polite"></div>
             <div class="message error-message hidden" id="error-message" role="alert" aria-live="assertive"></div>
        </div>

        <div class="buttons">
            <button type="button" id="save-settings-btn">すべての設定を保存</button>
            <a href="index.html" target="_blank" class="button btn-preview">メイン画面をプレビュー</a> <a href="index.html" class="button btn-home">メイン画面に戻る</a> </div>
    </div>

    <footer>
        友情の木 管理ツール
    </footer>

    <script>
        const adminApp = {
            // --- 定数 ---
            TOTAL_STAGES: 30, // 段階は0から30まで
            get CONFIG_ARRAY_LENGTH() { return this.TOTAL_STAGES + 1; }, // 配列長 (31)
            API_URL_STORAGE_KEY: 'treeAppApiUrl',
            DEFAULT_API_URL: '', // ★★★ 必ず実際のGAS WebアプリURLを設定してください ★★★ 例: 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec'
            IMAGE_SIZE_LIMIT: 5 * 1024 * 1024, // 5MB
            WHITE_PIXEL: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/wcAAwAB/7+98QAAAABJRU5ErkJggg==',

            // --- 状態 ---
            config: {
                apiUrl: '',
                stages: [], // initで初期化
                images: []  // initで初期化
            },
            elements: {}, // DOM要素キャッシュ (initで設定)
            selectedFile: null, // アップロード用に選択されたファイル
            isLoading: false, // ローディング状態管理
            messageTimeoutId: null, // メッセージ表示タイマー

            // --- 初期化 ---
            init: function() {
                this.initializeConfigArrays();
                this.cacheElements();
                this.loadApiUrl();
                this.setupEventListeners();
                this.updateStageSelector(); // 先にセレクタを生成

                if (this.config.apiUrl && this.config.apiUrl !== this.DEFAULT_API_URL) {
                    this.loadConfigFromServer(); // API URLがあればサーバーから設定読込
                } else {
                     console.warn('API URLが設定されていません。デフォルト設定でUIを初期化します。');
                     this.showErrorMessage('ようこそ！まず「基本設定」タブで Google Apps Script の API URL を入力し、「すべての設定を保存」ボタンを押してください。', 10000);
                     this.config.stages = this.generateDefaultStages(); // デフォルト段階を生成
                     this.updateUI(); // ローカルのデフォルト設定でUI更新
                }
                this.activateTab('basic-settings'); // 初期タブ
            },

            initializeConfigArrays: function() {
                this.config.stages = Array(this.CONFIG_ARRAY_LENGTH).fill(0);
                this.config.images = Array(this.CONFIG_ARRAY_LENGTH).fill('');
            },

            cacheElements: function() {
                this.elements = {
                    apiUrlInput: document.getElementById('api-url'),
                    stageSelector: document.getElementById('stage-selector'),
                    imageUploadInput: document.getElementById('image-upload-input'),
                    fileInfo: document.getElementById('file-info'),
                    uploadImageBtn: document.getElementById('upload-image-btn'),
                    imageIdUrlInput: document.getElementById('image-id-url-input'),
                    setIdUrlBtn: document.getElementById('set-id-url-btn'),
                    uploadProgress: document.getElementById('upload-progress'),
                    imageGrid: document.getElementById('image-grid'),
                    saveSettingsBtn: document.getElementById('save-settings-btn'),
                    // previewBtn: document.getElementById('preview-btn'), // aタグに変更
                    // homeBtn: document.getElementById('home-btn'), // aタグに変更
                    loader: document.getElementById('loader'),
                    successMessage: document.getElementById('success-message'),
                    errorMessage: document.getElementById('error-message'),
                    messageArea: document.getElementById('message-area'),
                    stageRowsContainer: document.getElementById('stage-rows-container'),
                    resetStagesBtn: document.getElementById('reset-stages-btn'),
                    autoDistributeBtn: document.getElementById('auto-distribute-btn'),
                    maxMeetingsInput: document.getElementById('max-meetings'),
                    tabs: document.querySelectorAll('.tab'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    testConnectionBtn: document.getElementById('test-connection-btn'),
                    saveStagesOnlyBtn: document.getElementById('save-stages-only-btn'),
                    saveImagesOnlyBtn: document.getElementById('save-images-only-btn'),
                    clearAllImagesBtn: document.getElementById('clear-all-images-btn'),
                    debugMode: document.getElementById('debug-mode'),
                    debugInfo: document.getElementById('debug-info'),
                    // hiddenFrame: document.getElementById('hidden-frame') // 代替手段用 (通常不要)
                };
            },

            loadApiUrl: function() {
                const savedApiUrl = localStorage.getItem(this.API_URL_STORAGE_KEY);
                this.config.apiUrl = savedApiUrl || this.DEFAULT_API_URL;
                this.elements.apiUrlInput.value = this.config.apiUrl;
            },

            setupEventListeners: function() {
                // タブ切り替え
                this.elements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => this.activateTab(tab.dataset.tab));
                });

                // API URL 変更時 (入力時ではなく変更完了時に保存)
                this.elements.apiUrlInput.addEventListener('change', () => {
                    this.config.apiUrl = this.elements.apiUrlInput.value.trim();
                    localStorage.setItem(this.API_URL_STORAGE_KEY, this.config.apiUrl);
                    this.showMessage('success', 'API URLをブラウザに記憶しました。設定を反映するには「すべての設定を保存」を押してください。');
                    // 変更後すぐに接続テストや設定読込を行うかはお好みで
                    // this.testConnection();
                });

                // 基本設定タブのボタン
                this.elements.testConnectionBtn.addEventListener('click', () => this.testConnection());
                this.elements.saveStagesOnlyBtn.addEventListener('click', () => this.saveConfiguration('stagesOnly'));
                this.elements.saveImagesOnlyBtn.addEventListener('click', () => this.saveConfiguration('imagesOnly'));
                this.elements.clearAllImagesBtn.addEventListener('click', () => this.clearAllImages());

                // 成長段階設定タブのボタン
                this.elements.resetStagesBtn.addEventListener('click', () => this.resetStagesToDefault());
                this.elements.autoDistributeBtn.addEventListener('click', () => this.autoDistributeStages());
                // 成長段階入力 (イベントデリゲーション)
                this.elements.stageRowsContainer.addEventListener('change', (event) => {
                    if (event.target.classList.contains('stage-input')) {
                        this.handleStageInputChange(event.target);
                    }
                });

                // 画像設定タブの要素
                this.elements.stageSelector.addEventListener('change', () => this.handleStageSelectionChange());
                this.elements.imageUploadInput.addEventListener('change', (event) => this.handleFileSelection(event));
                this.elements.uploadImageBtn.addEventListener('click', () => this.uploadSelectedImage());
                this.elements.setIdUrlBtn.addEventListener('click', () => this.setImageFromUrlOrId());

                // デバッグモード
                this.elements.debugMode.addEventListener('change', () => {
                    if (!this.elements.debugMode.checked) {
                        this.elements.debugInfo.classList.add('hidden');
                        this.elements.debugInfo.textContent = '';
                    }
                });

                // メインの保存ボタン
                this.elements.saveSettingsBtn.addEventListener('click', () => this.saveConfiguration('all'));

                /*
                // --- postMessage を使う場合のリスナー (通常は不要) ---
                window.addEventListener('message', (event) => {
                    // 送信元がGASのオリジンか確認 (より安全にする場合)
                    // if (event.origin !== "https://script.google.com") return;

                    console.log('Message received from iframe:', event.data);
                    this.hideLoader(); // ローダーを隠す

                    if (event.data && typeof event.data === 'object') {
                        if (event.data.status === 'success') {
                            this.showMessage('success', event.data.message || '設定を保存しました！(iframe経由)');
                            // 必要に応じて設定を再読み込み or UI更新
                        } else {
                            this.showMessage('error', `iframe経由の保存失敗: ${event.data.message || '不明なエラー'}`);
                        }
                    } else {
                        this.showMessage('error', 'iframeから予期しない形式のデータを受信しました。');
                    }

                    // 送信に使ったiframeを削除するなどの後処理 (任意)
                    const iframe = this.elements.hiddenFrame;
                    if (iframe && iframe.parentNode) {
                         // iframe.parentNode.removeChild(iframe);
                    }
                });
                */
            },

            // --- API 通信 ---
            /**
             * APIエンドポイントにリクエストを送信する共通関数
             * @param {string} action - GAS側で処理を判別するためのアクション名
             * @param {object} payload - 送信するデータ本体
             * @param {string} method - HTTPメソッド ('GET' or 'POST')
             * @returns {Promise<object>} - サーバーからのレスポンスデータ (JSON)
             */
            fetchApi: async function(action, payload = null, method = 'GET') {
                if (!this.config.apiUrl || this.config.apiUrl === this.DEFAULT_API_URL) {
                    throw new Error('API URLが設定されていません。');
                }

                const isDebug = this.elements.debugMode.checked;
                // GETの場合はクエリパラメータ、POSTの場合はボディとクエリパラメータにactionを追加
                let url = this.config.apiUrl;
                const fetchOptions = {
                    method: method,
                    mode: 'cors', // CORSリクエストを許可
                    cache: 'no-cache',
                    redirect: 'follow',
                    referrerPolicy: 'no-referrer',
                };

                if (method === 'GET') {
                    const params = new URLSearchParams({ action });
                    if (payload) { // GETでもペイロードが必要な場合 (通常はactionのみ)
                        Object.keys(payload).forEach(key => params.append(key, payload[key]));
                    }
                    if (isDebug) params.append('debug', 'true');
                    url += `?${params.toString()}`;
                } else if (method === 'POST') {
                    fetchOptions.headers = {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    };
                    const body = { action, ...payload }; // actionもボディに含める
                    fetchOptions.body = JSON.stringify(body);
                    if (isDebug) url += (url.includes('?') ? '&' : '?') + 'debug=true'; // デバッグフラグはURLに
                }

                 if (this.elements.debugMode.checked) {
                     console.log(`[DEBUG] Fetching API: ${method} ${url}`, fetchOptions.body ? JSON.parse(fetchOptions.body) : '');
                 }

                const response = await fetch(url, fetchOptions);
                return this.handleApiResponse(response); // レスポンス処理は共通化
            },

            /**
             * fetchのレスポンスを処理し、エラーがあれば例外を投げる
             * @param {Response} response - fetchのレスポンスオブジェクト
             * @returns {Promise<object>} - 正常な場合のJSONデータ
             */
            handleApiResponse: async function(response) {
                 if (this.elements.debugMode.checked) {
                     console.log('[DEBUG] Server Response Status:', response.status);
                 }

                if (!response.ok) {
                    let errorText = `サーバーエラー: ${response.status} ${response.statusText}`;
                    let errorDetails = '';
                    try {
                        // エラーレスポンスの本文を取得試行
                        const bodyText = await response.text();
                         if (this.elements.debugMode.checked) {
                             console.error('[DEBUG] Error Response Body:', bodyText);
                         }
                        errorDetails = bodyText.substring(0, 200); // 長すぎる場合は切り詰める
                         // JSON形式のエラーか試す
                         try {
                             const errorJson = JSON.parse(bodyText);
                             if (errorJson.message) {
                                 errorText = `サーバーエラー (${response.status}): ${errorJson.message}`;
                             }
                         } catch(e) { /* ignore json parse error */ }

                    } catch (e) {
                        console.error('Failed to read error response body:', e);
                    }
                    throw new Error(errorText + (errorDetails ? `\nDetails: ${errorDetails}` : ''));
                }

                try {
                    // 正常なレスポンスをJSONとして解析
                    const data = await response.json();
                     if (this.elements.debugMode.checked) {
                         console.log('[DEBUG] Server Response Data:', data);
                         // デバッグ情報を表示
                         if (data.debug) {
                             this.elements.debugInfo.classList.remove('hidden');
                             this.elements.debugInfo.innerHTML = `<strong>サーバー応答デバッグ情報:</strong><br>${JSON.stringify(data.debug, null, 2)}`;
                         }
                     }
                    // GAS側で { status: 'success', ... } のような形式を期待
                    if (data.status !== 'success') {
                        throw new Error(data.message || 'サーバーから予期しない応答がありました (status is not success)');
                    }
                    return data; // 成功データを返す
                } catch (e) {
                    console.error("Response parsing error or unexpected format:", e);
                    throw new Error("サーバーからの応答形式が正しくありません。");
                }
            },

            /**
             * API通信時のエラーを処理し、UIにメッセージを表示する
             * @param {Error} error - 発生したエラーオブジェクト
             * @param {string} context - エラーが発生した操作の文脈 (例: '設定の保存')
             */
            handleApiError: function(error, context = 'API通信') {
                console.error(`${context} エラー詳細:`, error);

                let errorMessage = `${context}に失敗しました。\n${error.message}`;

                // エラーの種類に応じたヒントを追加
                if (error.message.includes('Failed to fetch')) {
                     errorMessage += '\n-> ネットワーク接続を確認するか、API URLが正しいか確認してください。CORS設定がGAS側で必要かもしれません。';
                 } else if (error.message.includes('API URLが設定されていません')) {
                     errorMessage += '\n-> 「基本設定」タブでAPI URLを設定してください。';
                 } else if (error.message.includes('サーバーエラー')) {
                     errorMessage += '\n-> GAS側のスクリプトに問題がある可能性があります。GASエディタのログを確認してください。';
                 } else if (error.message.includes('応答形式が正しくありません')) {
                      errorMessage += '\n-> GAS側が期待されるJSON形式 ({status:"success", ...}) で応答していない可能性があります。';
                 }

                this.showMessage('error', errorMessage, 15000); // エラーは長めに表示

                 // デバッグモードなら詳細情報を表示
                 if (this.elements.debugMode.checked) {
                     this.elements.debugInfo.classList.remove('hidden');
                     this.elements.debugInfo.innerHTML = `<strong>${context} エラー:</strong><br>${error.toString()}<br><strong>Stack:</strong><br>${error.stack || '(Stack trace not available)'}`;
                 }
            },

            // --- 設定の読み込み・保存 ---
            loadConfigFromServer: async function() {
                this.setLoading(true, '設定読み込み中...');
                try {
                    const data = await this.fetchApi('getConfig', null, 'GET');
                    // stagesとimagesを読み込む (配列長と型チェック)
                    const isValidArray = (arr, expectedLength) => Array.isArray(arr) && arr.length === expectedLength;

                    if (isValidArray(data.stages, this.CONFIG_ARRAY_LENGTH)) {
                         // stage 0 は強制的に 0 にする
                         data.stages[0] = 0;
                         this.config.stages = data.stages;
                    } else {
                         console.warn('サーバーから受信した stages データが無効です。デフォルト値を使用します。Received:', data.stages);
                         // 不正な場合はデフォルト値を再生成
                         this.config.stages = this.generateDefaultStages();
                    }

                    if (isValidArray(data.images, this.CONFIG_ARRAY_LENGTH)) {
                         this.config.images = data.images;
                    } else {
                         console.warn('サーバーから受信した images データが無効です。空の配列を使用します。Received:', data.images);
                         this.config.images = Array(this.CONFIG_ARRAY_LENGTH).fill('');
                    }

                    console.log('サーバーから設定を読み込みました:', this.config);
                    this.updateUI(); // UI全体を更新
                    this.showMessage('success', 'サーバーから設定を読み込みました');
                } catch (error) {
                    this.handleApiError(error, 'サーバーからの設定取得');
                    // エラー時も現在のローカルconfigでUI表示試みる
                    if (!isValidArray(this.config.stages, this.CONFIG_ARRAY_LENGTH)) {
                        this.config.stages = this.generateDefaultStages(); // Stageだけでもデフォルトに
                    }
                    this.updateUI();
                } finally {
                    this.setLoading(false);
                }
            },

            /**
             * 設定をサーバーに保存する共通関数
             * @param {string} saveType - 'all', 'stagesOnly', 'imagesOnly'
             */
            saveConfiguration: async function(saveType = 'all') {
                 if (this.isLoading) return; // 処理中なら何もしない

                let loadingMessage = '';
                let configPayload = {};

                // 最初にStage Inputの値をconfigに反映
                this.updateConfigStagesFromInputs();

                switch (saveType) {
                    case 'stagesOnly':
                        configPayload = { stages: this.config.stages }; // imagesは送らない (GAS側で判別)
                        loadingMessage = '成長段階設定を保存中...';
                        break;
                    case 'imagesOnly':
                        configPayload = { images: this.config.images }; // stagesは送らない (GAS側で判別)
                        loadingMessage = '画像設定を保存中...';
                        break;
                    default: // 'all'
                        configPayload = { stages: this.config.stages, images: this.config.images };
                        loadingMessage = 'すべての設定を保存中...';
                }

                // 保存対象のデータをログ出力 (デバッグ用)
                if (this.elements.debugMode.checked) {
                    console.log(`[DEBUG] Saving configuration (${saveType}):`, configPayload);
                }

                this.setLoading(true, loadingMessage);
                try {
                    // saveTypeもpayloadに含めてGAS側で処理を振り分けやすくする
                    const payload = { config: configPayload, saveType: saveType };
                    const data = await this.fetchApi('saveConfig', payload, 'POST');

                    this.showMessage('success', data.message || `${saveType === 'all' ? 'すべて' : saveType === 'stagesOnly' ? '成長段階' : '画像'}の設定を保存しました！`);

                    // API URL自体もここでブラウザに記憶させる（変更があった場合）
                    localStorage.setItem(this.API_URL_STORAGE_KEY, this.config.apiUrl);

                } catch (error) {
                    this.handleApiError(error, `設定 (${saveType}) の保存`);
                    // ここで formPostData を試すロジックを入れることも可能だが、
                    // fetchエラーの原因解決を優先することを推奨
                    /*
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        console.warn('Fetch failed, attempting fallback with form post...');
                        this.saveSettingsViaForm(saveType, configPayload); // 代替手段を試す
                    }
                    */
                } finally {
                    this.setLoading(false);
                }
            },

            // --- 接続テスト ---
            testConnection: async function() {
                if (this.isLoading) return;
                this.setLoading(true, '接続テスト中...');
                try {
                    const data = await this.fetchApi('test', null, 'GET');
                    this.showMessage('success', '接続テスト成功！サーバーと正常に通信できています。');
                     // デバッグモードなら応答内容表示
                     if (this.elements.debugMode.checked) {
                         this.elements.debugInfo.classList.remove('hidden');
                         this.elements.debugInfo.innerHTML = `<strong>接続テスト サーバー応答:</strong><br>${JSON.stringify(data, null, 2)}`;
                     }
                } catch (error) {
                    this.handleApiError(error, '接続テスト');
                } finally {
                    this.setLoading(false);
                }
            },

            // --- UI 更新 ---
            updateUI: function() {
                // 最大交流回数入力欄 (Stage設定から最大値を取得して表示)
                this.elements.maxMeetingsInput.value = this.getMeetingsMaxValueFromConfig();

                // 現在アクティブなタブの内容を更新
                const activeTabId = document.querySelector('.tab.active')?.dataset.tab;
                if (activeTabId === 'stage-settings') {
                    this.updateStageSettingsUI();
                } else if (activeTabId === 'image-settings') {
                     this.updateStageSelector(); // セレクタも更新が必要な場合がある
                     this.handleStageSelectionChange(); // 選択中の情報を反映
                     this.updateImageGridUI();
                } else if (activeTabId === 'basic-settings') {
                    // 基本設定タブ特有の更新があればここに追加
                }
            },

            activateTab: function(tabId) {
                this.elements.tabs.forEach(tab => {
                     tab.classList.toggle('active', tab.dataset.tab === tabId);
                });
                this.elements.tabContents.forEach(content => {
                     content.classList.toggle('active', content.id === tabId);
                });

                // タブ切り替え時に内容を更新
                this.updateUI(); // UI全体を更新するのが手っ取り早い
                // 特定のタブだけで良いなら下記のように
                /*
                if (tabId === 'stage-settings') {
                    this.updateStageSettingsUI();
                } else if (tabId === 'image-settings') {
                    this.updateImageGridUI();
                    this.updateStageSelector(); // セレクタも更新
                    this.handleStageSelectionChange();
                }
                */
            },

            // --- 成長段階 (Stages) 関連 ---
             /**
             * デフォルトの成長段階の交流回数配列を生成する
             * @returns {number[]}
             */
             generateDefaultStages: function(maxMeetings = 150) {
                const stages = [0]; // Stage 0 は常に 0
                if (maxMeetings <= 0) maxMeetings = 1;
                for (let i = 1; i <= this.TOTAL_STAGES; i++) {
                    // より緩やかな増加カーブにする例 (平方根を使うなど)
                    // const meetingsRequired = Math.max(1, Math.ceil(Math.sqrt(i / this.TOTAL_STAGES) * maxMeetings));
                    // 単純な比例配分
                    const meetingsRequired = Math.max(1, Math.ceil((i / this.TOTAL_STAGES) * maxMeetings));
                    stages.push(meetingsRequired);
                }
                console.log(`Generated default stages with maxMeetings=${maxMeetings}:`, stages);
                return stages;
            },

            getMeetingsMaxValueFromConfig: function() {
                // stage 0 を除いた最大値を取得、最低でも 1 を返す
                return Math.max(1, ...this.config.stages.slice(1));
            },

            resetStagesToDefault: function() {
                if (confirm('段階設定を初期値に戻しますか？（現在の最大交流回数の値に基づいて計算されます）')) {
                    const maxMeetings = parseInt(this.elements.maxMeetingsInput.value) || this.getMeetingsMaxValueFromConfig() || 150;
                    this.config.stages = this.generateDefaultStages(maxMeetings);
                    this.updateStageSettingsUI();
                    this.showMessage('success', '段階設定を初期値にリセットしました。(保存ボタンで確定)');
                }
            },

            autoDistributeStages: function() {
                const maxMeetings = parseInt(this.elements.maxMeetingsInput.value) || 150;
                 if (maxMeetings <= 0) {
                     this.showMessage('error', '最大交流回数は1以上で設定してください。');
                     return;
                 }
                this.config.stages = this.generateDefaultStages(maxMeetings);
                this.updateStageSettingsUI();
                this.showMessage('success', '段階設定を均等に自動設定しました。(保存ボタンで確定)');
            },

            /** Stage Input の変更を config.stages に反映する */
            handleStageInputChange: function(inputElement) {
                const stage = parseInt(inputElement.dataset.stage);
                let value = parseInt(inputElement.value) || 0;
                if (value < 0) value = 0;

                if (stage >= 0 && stage < this.config.stages.length) {
                    if (stage === 0) {
                        this.config.stages[0] = 0;
                        inputElement.value = 0; // Stage 0 は強制的に 0
                    } else {
                        // 簡単なバリデーション: 前の段階の値より小さくならないように
                        const prevStageValue = this.config.stages[stage - 1] ?? 0;
                        if (value < prevStageValue) {
                             console.warn(`Stage ${stage} value (${value}) is less than previous stage (${prevStageValue}). Adjusting.`);
                             value = prevStageValue; // 前の段階と同じ値に補正
                             inputElement.value = value;
                             this.showMessage('warning', `段階 ${stage} の値は段階 ${stage - 1} (${prevStageValue}) 以上である必要があります。自動補正しました。`, 5000);
                        }
                        this.config.stages[stage] = value;

                        // さらに、後の段階の値がこの段階の値より小さければ、それらも補正する
                        for (let i = stage + 1; i < this.config.stages.length; i++) {
                            if (this.config.stages[i] < value) {
                                console.log(`Adjusting stage ${i} from ${this.config.stages[i]} to ${value}`);
                                this.config.stages[i] = value;
                                // 対応するinput要素も更新
                                const nextInput = this.elements.stageRowsContainer.querySelector(`.stage-input[data-stage="${i}"]`);
                                if (nextInput) nextInput.value = value;
                            }
                        }
                    }
                     if (this.elements.debugMode.checked) {
                         console.log('[DEBUG] config.stages updated:', this.config.stages);
                     }
                }
            },

            /** config.stages の値に基づいてHTMLの入力欄を更新する */
            updateStageSettingsUI: function() {
                // DocumentFragmentを使ってDOM操作を効率化
                const fragment = document.createDocumentFragment();

                // 配列長チェックと補正
                while (this.config.stages.length < this.CONFIG_ARRAY_LENGTH) this.config.stages.push(0);
                this.config.stages = this.config.stages.slice(0, this.CONFIG_ARRAY_LENGTH);
                if(this.config.stages[0] !== 0) { // 念のためStage 0を0に
                    this.config.stages[0] = 0;
                }

                for (let i = 0; i <= this.TOTAL_STAGES; i++) {
                    const row = document.createElement('div');
                    row.className = 'stage-row';

                    const stageLabel = document.createElement('div');
                    stageLabel.textContent = `段階 ${i}`;

                    const inputContainer = document.createElement('div');
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.className = 'stage-input';
                    input.value = this.config.stages[i];
                    input.dataset.stage = i; // data属性で段階を保持

                    if (i === 0) {
                        input.readOnly = true; // Stage 0 は編集不可
                    }

                    inputContainer.appendChild(input);
                    row.appendChild(stageLabel);
                    row.appendChild(inputContainer);
                    fragment.appendChild(row);
                }
                // コンテナをクリアして一括挿入
                this.elements.stageRowsContainer.innerHTML = '';
                this.elements.stageRowsContainer.appendChild(fragment);
            },

            /** 保存直前にInputの値からconfig.stagesを更新 */
            updateConfigStagesFromInputs: function() {
                const stageInputs = this.elements.stageRowsContainer.querySelectorAll('.stage-input');
                stageInputs.forEach(input => {
                    const stage = parseInt(input.dataset.stage);
                    let value = parseInt(input.value) || 0;
                    if (value < 0) value = 0;
                    if (stage === 0) value = 0;
                    if(stage >= 0 && stage < this.config.stages.length) {
                        this.config.stages[stage] = value;
                    }
                });
                if (this.elements.debugMode.checked) {
                    console.log('[DEBUG] config.stages synced from inputs before save:', this.config.stages);
                }
            },


            // --- 画像 (Images) 関連 ---
            updateStageSelector: function() {
                const selectedValue = this.elements.stageSelector.value; // 現在の値保持
                const fragment = document.createDocumentFragment();
                for (let i = 0; i <= this.TOTAL_STAGES; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `段階 ${i}`;
                    fragment.appendChild(option);
                }
                this.elements.stageSelector.innerHTML = '';
                this.elements.stageSelector.appendChild(fragment);

                // 以前の選択値を復元 (存在すれば)
                if (selectedValue && parseInt(selectedValue) >= 0 && parseInt(selectedValue) <= this.TOTAL_STAGES) {
                    this.elements.stageSelector.value = selectedValue;
                } else {
                    this.elements.stageSelector.value = '0'; // デフォルトは0
                }
            },

            handleStageSelectionChange: function() {
                this.resetFileInput(); // ファイル選択・入力欄リセット
                // 選択中の段階の画像ID/URLをURL/ID入力欄に表示（編集用）
                const stageIndex = parseInt(this.elements.stageSelector.value);
                if (stageIndex >= 0 && stageIndex < this.config.images.length) {
                    this.elements.imageIdUrlInput.value = this.config.images[stageIndex] || '';
                } else {
                    this.elements.imageIdUrlInput.value = ''; // 範囲外ならクリア
                }
                // 他にも選択変更時に行いたい処理があればここに追加
            },

            handleFileSelection: function(event) {
                const file = event.target.files[0];
                if (file) {
                    // ファイルサイズチェック
                    if (file.size > this.IMAGE_SIZE_LIMIT) {
                        this.showMessage('error', `ファイルサイズが大きすぎます (${(this.IMAGE_SIZE_LIMIT / 1024 / 1024).toFixed(1)}MB以下にしてください)`);
                        this.resetFileInput();
                        return;
                    }
                    // ファイルタイプ簡易チェック (accept属性と併用)
                    if (!['image/png', 'image/jpeg', 'image/gif'].includes(file.type)) {
                         this.showMessage('warning', `サポートされていないファイル形式です (PNG, JPG, GIFを推奨)。`, 5000);
                         // 処理は続行するかもしれない
                    }

                    this.elements.fileInfo.textContent = `選択中: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    this.selectedFile = file;
                    this.elements.uploadImageBtn.disabled = false;
                    this.elements.imageIdUrlInput.value = ''; // URL/ID入力欄はクリア
                    this.elements.uploadProgress.textContent = ''; // 進捗メッセージクリア
                } else {
                    this.resetFileInput();
                }
            },

            resetFileInput: function() {
                this.elements.imageUploadInput.value = ''; // ファイル選択解除
                this.elements.fileInfo.textContent = '';
                this.selectedFile = null;
                this.elements.uploadImageBtn.disabled = true;
                this.elements.uploadProgress.textContent = '';
                // imageIdUrlInput は handleStageSelectionChange で制御するのでここではクリアしない
            },

            uploadSelectedImage: async function() {
                if (!this.selectedFile) {
                    this.showMessage('error', 'アップロードする画像ファイルを選択してください。');
                    return;
                }
                if (this.isLoading) return;

                const stageIndex = parseInt(this.elements.stageSelector.value);
                this.setLoading(true, '画像をアップロード中...');
                this.elements.uploadProgress.textContent = 'ファイル読み込み中...';
                this.elements.uploadImageBtn.disabled = true; // 処理中はボタン無効化
                this.elements.setIdUrlBtn.disabled = true;

                try {
                    const base64Data = await this.readFileAsBase64(this.selectedFile);
                    this.elements.uploadProgress.textContent = 'サーバーに送信中...';

                    const payload = {
                        fileData: {
                            base64: base64Data,
                            type: this.selectedFile.type,
                            name: this.selectedFile.name
                        },
                        // stageIndexも送るとGAS側でフォルダ分けなどに使えるかも
                        stageIndex: stageIndex
                    };
                    const data = await this.fetchApi('uploadImage', payload, 'POST');

                    // uploadImageアクションは fileId を返すことを期待
                    if (data.fileId) {
                        this.setImageIdentifierInternal(stageIndex, data.fileId); // 内部状態更新 & グリッド更新
                        this.showMessage('success', `段階 ${stageIndex} の画像をアップロード完了！ Drive ID: ${data.fileId} (保存ボタンで確定)`);
                        this.resetFileInput(); // 成功したらリセット
                         this.elements.imageIdUrlInput.value = data.fileId; // 入力欄にもIDを表示
                    } else {
                        throw new Error('サーバーからファイルIDが返されませんでした。');
                    }
                } catch (error) {
                    this.handleApiError(error, '画像アップロード');
                    this.resetFileInput(); // 失敗時もリセット
                } finally {
                    this.setLoading(false);
                    // ボタンの有効/無効は resetFileInput や handleStageSelectionChange で制御される
                    this.elements.setIdUrlBtn.disabled = false; // URL/ID設定ボタンは再度有効化
                    this.elements.uploadProgress.textContent = ''; // 進捗クリア
                }
            },

            readFileAsBase64: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result); // base64文字列を返す
                    reader.onerror = (error) => reject(new Error('ファイルの読み込みに失敗しました: ' + error));
                    reader.readAsDataURL(file);
                });
            },

            setImageFromUrlOrId: function() {
                const stageIndex = parseInt(this.elements.stageSelector.value);
                const idOrUrl = this.elements.imageIdUrlInput.value.trim();

                if (!idOrUrl) { // 入力が空の場合 -> クリア確認
                    if (this.config.images[stageIndex]) { // 何か設定されていた場合のみ確認
                        if (confirm(`段階 ${stageIndex} の画像をクリアしますか？`)) {
                            this.setImageIdentifierInternal(stageIndex, '');
                            this.showMessage('success', `段階 ${stageIndex} の画像をクリアしました。(保存ボタンで確定)`);
                        }
                    }
                    return;
                }

                // 簡単な形式チェック (任意) - スペースが含まれていたら警告など
                 if (idOrUrl.includes(' ') && !idOrUrl.startsWith('data:')) {
                     if (!confirm("入力にスペースが含まれています。URLまたはIDとして無効な可能性がありますが、このまま設定しますか？")) {
                         return;
                     }
                 }

                this.setImageIdentifierInternal(stageIndex, idOrUrl);
                this.showMessage('success', `段階 ${stageIndex} にURL/IDを設定しました。(保存ボタンで確定)`);
                 this.resetFileInput(); // URL/IDを設定したらファイル選択はリセット
            },

            clearAllImages: function() {
                 if (confirm('本当にすべての画像設定（URL/ID）をクリアしますか？この操作は元に戻せません。')) {
                     this.config.images = Array(this.CONFIG_ARRAY_LENGTH).fill('');
                     this.updateImageGridUI(); // グリッド表示を更新
                     this.handleStageSelectionChange(); // 現在選択中のURL/ID入力欄もクリア
                     this.showMessage('success', 'すべての画像設定をクリアしました。(保存ボタンで確定)');
                 }
            },

            /**
             * 画像識別子 (URL or ID) を内部configに設定し、UI (グリッド) を更新する
             * @param {number} stageIndex - 対象の段階インデックス
             * @param {string} identifier - 設定するURLまたはID (空文字列でクリア)
             */
            setImageIdentifierInternal: function(stageIndex, identifier) {
                if (stageIndex >= 0 && stageIndex < this.config.images.length) {
                    let cleanIdentifier = identifier.trim();
                    // Flickr URLの場合、クエリパラメータを削除する (任意)
                    if (cleanIdentifier.includes('flickr.com/photos/')) {
                        try {
                            const url = new URL(cleanIdentifier);
                            cleanIdentifier = url.origin + url.pathname; // パスまでにする
                        } catch(e) { /* invalid URL, use as is */}
                    }
                    this.config.images[stageIndex] = cleanIdentifier;
                     if (this.elements.debugMode.checked) {
                         console.log(`[DEBUG] Image set for stage ${stageIndex}:`, cleanIdentifier);
                         console.log('[DEBUG] config.images updated:', this.config.images);
                     }
                    this.updateImageGridUI(); // グリッドを更新して反映
                }
            },

            /** 画像グリッドのHTMLを生成・更新する */
            updateImageGridUI: function() {
                 // 配列長チェックと補正
                 while (this.config.images.length < this.CONFIG_ARRAY_LENGTH) this.config.images.push('');
                 this.config.images = this.config.images.slice(0, this.CONFIG_ARRAY_LENGTH);

                const fragment = document.createDocumentFragment();
                this.config.images.forEach((identifier, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';

                    const stageNumber = document.createElement('div');
                    stageNumber.className = 'stage-number';
                    stageNumber.textContent = `段階 ${index}`;

                    const img = document.createElement('img');
                    img.alt = `成長段階 ${index} の画像`;
                    img.loading = 'lazy'; // 遅延読み込み

                    let displayIdentifier = identifier || '(未設定)';
                    let imageSrc = this.whitePixel; // デフォルトは白画像
                    let titleText = `段階 ${index}: ${displayIdentifier}`;

                    if (identifier) {
                        if (identifier.startsWith('data:image')) { // Base64 データ
                            imageSrc = identifier;
                            displayIdentifier = '(Base64画像)';
                            titleText = `段階 ${index}: Base64画像`;
                        } else if (identifier.includes('flickr.com')) { // Flickr
                            imageSrc = identifier; // そのまま表示試行
                             displayIdentifier = identifier.split('/').slice(-2).join('/'); // 末尾部分を表示
                             titleText = `段階 ${index}: Flickr - ${identifier}`;
                        } else if (identifier.length > 20 && !identifier.startsWith('http') && !identifier.includes('/')) { // Google Drive ID (推測)
                            imageSrc = `https://drive.google.com/uc?export=view&id=${identifier}`;
                             displayIdentifier = `Drive ID: ...${identifier.slice(-8)}`; // 末尾8文字表示
                             titleText = `段階 ${index}: Drive ID - ${identifier}`;
                        } else if (identifier.startsWith('http')) { // 一般的なURL
                             imageSrc = identifier;
                             try { // URLの一部を表示
                                const url = new URL(identifier);
                                displayIdentifier = `${url.hostname}${url.pathname.substring(0, 20)}...`;
                             } catch(e) {
                                 displayIdentifier = identifier.substring(0, 30) + '...';
                             }
                             titleText = `段階 ${index}: URL - ${identifier}`;
                        } else { // その他 (不明なIDなど)
                             imageSrc = this.whitePixel; // 不明な場合は表示しない
                             displayIdentifier = `不明: ${identifier.substring(0, 20)}...`;
                             titleText = `段階 ${index}: 不明な識別子 - ${identifier}`;
                             console.warn(`Unknown image identifier format for stage ${index}: ${identifier}`);
                        }
                    }

                    img.src = imageSrc;
                    img.title = titleText; // ツールチップに詳細表示
                    img.onerror = () => {
                        console.warn(`画像読込エラー: Stage ${index}, Identifier: ${identifier}`);
                        img.src = this.whitePixel; // エラー時は白画像
                        img.alt = `成長段階 ${index} (画像読込エラー)`;
                         // エラー表示を追加
                         const errorMsg = imageItem.querySelector('.image-load-error');
                         if(errorMsg) errorMsg.textContent = '表示エラー';
                    };

                     const identifierDiv = document.createElement('div');
                     identifierDiv.className = 'image-identifier';
                     identifierDiv.textContent = displayIdentifier;

                     const errorDiv = document.createElement('div'); // エラー表示用
                     errorDiv.className = 'image-load-error';
                     errorDiv.style.color = 'red';
                     errorDiv.style.fontSize = '0.8em';

                     const buttonWrapper = document.createElement('div');
                     buttonWrapper.className = 'edit-button-wrapper';
                     const editBtn = document.createElement('button');
                     editBtn.textContent = '編集/クリア';
                     editBtn.type = 'button'; // form送信を防ぐ
                     editBtn.className = 'btn-small';
                     editBtn.addEventListener('click', () => {
                         this.elements.stageSelector.value = index;
                         this.handleStageSelectionChange(); // セレクタ変更時の処理を呼ぶ
                         this.activateTab('image-settings'); // 画像設定タブへ移動
                         // スクロールして入力欄を表示 (任意)
                         this.elements.imageIdUrlInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         this.elements.imageIdUrlInput.focus();
                     });
                     buttonWrapper.appendChild(editBtn);

                    imageItem.appendChild(stageNumber);
                    imageItem.appendChild(img);
                    imageItem.appendChild(identifierDiv);
                    imageItem.appendChild(errorDiv); // エラー表示用 placeholder
                    imageItem.appendChild(buttonWrapper);
                    fragment.appendChild(imageItem);
                });
                 this.elements.imageGrid.innerHTML = '';
                 this.elements.imageGrid.appendChild(fragment);
            },


            // --- ユーティリティ ---
            setLoading: function(isLoading, message = '') {
                this.isLoading = isLoading;
                if (isLoading) {
                    this.elements.loader.classList.remove('hidden');
                    if (message) {
                        // ローダーにテキストを追加したい場合は別途要素を用意
                        // this.elements.loader.setAttribute('aria-label', message);
                        // メッセージエリアに進捗表示
                        this.elements.uploadProgress.textContent = message;
                    }
                    // 操作中のボタンを無効化
                    this.elements.saveSettingsBtn.disabled = true;
                    this.elements.saveStagesOnlyBtn.disabled = true;
                    this.elements.saveImagesOnlyBtn.disabled = true;
                    this.elements.testConnectionBtn.disabled = true;
                    this.elements.uploadImageBtn.disabled = true;
                    this.elements.setIdUrlBtn.disabled = true;
                } else {
                    this.elements.loader.classList.add('hidden');
                    this.elements.uploadProgress.textContent = ''; // 進捗クリア
                    // ボタンの有効状態をリセット (uploadImageBtnはファイル選択状態による)
                    this.elements.saveSettingsBtn.disabled = false;
                    this.elements.saveStagesOnlyBtn.disabled = false;
                    this.elements.saveImagesOnlyBtn.disabled = false;
                    this.elements.testConnectionBtn.disabled = false;
                    this.elements.uploadImageBtn.disabled = !this.selectedFile;
                    this.elements.setIdUrlBtn.disabled = false;
                }
            },

            showMessage: function(type, message, duration = 4000) {
                // 既存のメッセージタイマーがあればクリア
                if (this.messageTimeoutId) {
                    clearTimeout(this.messageTimeoutId);
                    this.messageTimeoutId = null;
                }
                // すべてのメッセージを一旦隠す
                this.elements.successMessage.classList.add('hidden');
                this.elements.errorMessage.classList.add('hidden');

                const targetElement = type === 'success' ? this.elements.successMessage : this.elements.errorMessage;
                targetElement.textContent = message;
                targetElement.classList.remove('hidden');

                // 指定時間後にメッセージを消すタイマーを設定
                this.messageTimeoutId = setTimeout(() => {
                    targetElement.classList.add('hidden');
                    targetElement.textContent = '';
                    this.messageTimeoutId = null; // タイマーIDクリア
                }, duration);
            },


            // --- 代替フォームポスト (非推奨, postMessage を使う場合の例) ---
             /*
            saveSettingsViaForm: function(saveType = 'all', configPayload) {
                 if (!this.config.apiUrl || this.config.apiUrl === this.DEFAULT_API_URL) {
                     this.showMessage('error', 'API URLが設定されていません。');
                     return;
                 }
                 // iframeが存在するか確認、なければ作成
                 let iframe = this.elements.hiddenFrame;
                 if (!iframe) {
                      iframe = document.createElement('iframe');
                      iframe.id = 'hidden-frame';
                      iframe.name = 'hidden-frame';
                      iframe.classList.add('hidden');
                      document.body.appendChild(iframe);
                      this.elements.hiddenFrame = iframe; // キャッシュ
                 }

                 const loadingMessage = `設定 (${saveType}) を保存中 (代替方式)...`;
                 this.setLoading(true, loadingMessage);

                 // 送信するデータ
                 const postData = {
                     action: 'saveConfig', // GAS側で判別するアクション
                     config: configPayload,
                     saveType: saveType,
                     // postMessageでの応答を期待することを示すフラグ (任意)
                     responseType: 'postMessage'
                 };

                 // フォームを動的に作成して送信
                 const form = document.createElement('form');
                 form.method = 'POST';
                 form.action = this.config.apiUrl;
                 form.target = iframe.name; // 隠しiframeをターゲットに
                 form.classList.add('hidden');

                 const dataField = document.createElement('input');
                 dataField.type = 'hidden';
                 dataField.name = 'payload'; // GAS側で受け取るパラメータ名 (例: e.parameter.payload)
                 dataField.value = JSON.stringify(postData);
                 form.appendChild(dataField);

                 document.body.appendChild(form);
                 form.submit();

                 // 送信後、フォームは不要なので削除
                 setTimeout(() => {
                     if (form.parentNode) {
                         form.parentNode.removeChild(form);
                     }
                 }, 500);

                 // 注意: 結果は window の 'message' イベントリスナーで受け取る必要があります。
                 // GAS側の doPost は以下のような応答を返す必要があります:
                 // function doPost(e) {
                 //   let result = { status: 'error', message: 'Unknown error' };
                 //   try {
                 //     const payload = JSON.parse(e.parameter.payload);
                 //     // ... 設定保存処理 ...
                 //     result = { status: 'success', message: '設定を保存しました' };
                 //   } catch(err) {
                 //     result.message = err.message;
                 //   }
                 //   // 親ウィンドウに結果を送信するHTMLを返す
                 //   const origin = e.origin || '*'; // 送信元のオリジンを取得できれば使う
                 //   const responseHtml = `<script>window.parent.postMessage(${JSON.stringify(result)}, '${origin}');</script>`;
                 //   return HtmlService.createHtmlOutput(responseHtml);
                 // }
                 // この代替方法は fetch がどうしても機能しない場合の最終手段です。
            }
            */

        };

        // --- アプリケーション実行 ---
        document.addEventListener('DOMContentLoaded', () => {
            // API URL が設定されていない場合は警告を表示
             if (!adminApp.DEFAULT_API_URL || adminApp.DEFAULT_API_URL === 'YOUR_DEFAULT_WEB_APP_URL_HERE') {
                  console.error("!!! 重要: adminApp.DEFAULT_API_URL に Google Apps Script の Web アプリ URL を設定してください !!!");
                  const warningDiv = document.createElement('div');
                  warningDiv.style.backgroundColor = 'red';
                  warningDiv.style.color = 'white';
                  warningDiv.style.padding = '10px';
                  warningDiv.style.textAlign = 'center';
                  warningDiv.style.fontWeight = 'bold';
                  warningDiv.textContent = 'エラー: JavaScriptコード内の adminApp.DEFAULT_API_URL が設定されていません。管理者に連絡してください。';
                  document.body.insertBefore(warningDiv, document.body.firstChild);
             }
            adminApp.init();
        });

    </script>
</body>
</html>
